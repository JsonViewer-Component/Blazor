name: ğŸ“¢ Manual Telegram Notification

on:
  workflow_dispatch:
    inputs:
      include_prerelease:
        description: 'Include pre-release versions?'
        required: false
        type: boolean
        default: true
      custom_message:
        description: 'Add custom message (optional)'
        required: false
        type: string

permissions:
  contents: read

jobs:
  send-notification:
    name: ğŸ“± Send Manual Notification
    runs-on: ubuntu-latest

    steps:
      # ========================================
      # 1ï¸âƒ£ Checkout Repository
      # ========================================
      - name: ğŸ“¥ Checkout repository
        uses: actions/checkout@v4

      # ========================================
      # 2ï¸âƒ£ Get Latest Release Info
      # ========================================
      - name: ğŸ” Fetch Latest Release
        id: latest_release
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          echo "ğŸ” Fetching latest release..."

          if [ "${{ inputs.include_prerelease }}" == "true" ]; then
            echo "ğŸ“¦ Including pre-release versions..."
            RELEASE_DATA=$(gh api repos/${{ github.repository }}/releases | jq '.[0]')
          else
            echo "ğŸ“¦ Stable releases only..."
            RELEASE_DATA=$(gh api repos/${{ github.repository }}/releases | jq '[.[] | select(.prerelease == false)][0]')
          fi

          if [ "$RELEASE_DATA" == "null" ] || [ -z "$RELEASE_DATA" ]; then
            echo "âŒ No release found!"
            exit 1
          fi

          # Ø§Ø³ØªØ®Ø±Ø§Ø¬ Ø§Ø·Ù„Ø§Ø¹Ø§Øª
          TAG_NAME=$(echo "$RELEASE_DATA" | jq -r '.tag_name')
          NAME=$(echo "$RELEASE_DATA" | jq -r '.name')
          BODY=$(echo "$RELEASE_DATA" | jq -r '.body')
          URL=$(echo "$RELEASE_DATA" | jq -r '.html_url')
          IS_PRERELEASE=$(echo "$RELEASE_DATA" | jq -r '.prerelease')
          PUBLISHED_AT=$(echo "$RELEASE_DATA" | jq -r '.published_at')

          echo "âœ… Found release: $TAG_NAME"

          # Ø°Ø®ÛŒØ±Ù‡ Ø¯Ø± Output
          echo "tag_name=$TAG_NAME" >> $GITHUB_OUTPUT
          echo "name=$NAME" >> $GITHUB_OUTPUT
          echo "url=$URL" >> $GITHUB_OUTPUT
          echo "is_prerelease=$IS_PRERELEASE" >> $GITHUB_OUTPUT
          echo "published_at=$PUBLISHED_AT" >> $GITHUB_OUTPUT

          # Ø°Ø®ÛŒØ±Ù‡ Body Ø¯Ø± ÙØ§ÛŒÙ„ (Ú†ÙˆÙ† Ù…Ù…Ú©Ù†Ù‡ Ø®ÛŒÙ„ÛŒ Ø¨Ø²Ø±Ú¯ Ø¨Ø§Ø´Ù‡)
          echo "$BODY" > release_body.txt

          echo "ğŸ“ Release body saved to file"

      # ========================================
      # 3ï¸âƒ£ Prepare Message for Telegram
      # ========================================
      - name: ğŸ“ Prepare Telegram Message
        id: prepare_message
        run: |
          TAG_NAME="${{ steps.latest_release.outputs.tag_name }}"
          NAME="${{ steps.latest_release.outputs.name }}"
          URL="${{ steps.latest_release.outputs.url }}"
          IS_PRERELEASE="${{ steps.latest_release.outputs.is_prerelease }}"
          PUBLISHED_AT="${{ steps.latest_release.outputs.published_at }}"
          CUSTOM_MSG="${{ inputs.custom_message }}"

          # Ø®ÙˆØ§Ù†Ø¯Ù† Body Ø§Ø² ÙØ§ÛŒÙ„
          BODY=$(cat release_body.txt)

          # ØªØ¨Ø¯ÛŒÙ„ Markdown Ø¨Ù‡ HTML (Ø³Ø§Ø¯Ù‡)
          BODY_HTML=$(echo "$BODY" | sed 's/^### \(.*\)$/<b>\1<\/b>/g' | sed 's/^## \(.*\)$/<b>\1<\/b>/g' | sed 's/\*\*\(.*\)\*\*/<b>\1<\/b>/g' | sed 's/`\([^`]*\)`/<code>\1<\/code>/g')

          # Ù…Ø­Ø¯ÙˆØ¯ Ú©Ø±Ø¯Ù† Ø·ÙˆÙ„ Body (Telegram limit: 4096 chars)
          if [ ${#BODY_HTML} -gt 2000 ]; then
            BODY_HTML="${BODY_HTML:0:2000}... <i>(truncated)</i>"
          fi

          # ØªØ´Ø®ÛŒØµ Ù†ÙˆØ¹ Release
          if [ "$IS_PRERELEASE" == "true" ]; then
            RELEASE_TYPE="âš ï¸ <b>Pre-release</b>"
          else
            RELEASE_TYPE="âœ… <b>Stable Release</b>"
          fi

          # Ø³Ø§Ø®Øª Ù¾ÛŒØ§Ù… Ù†Ù‡Ø§ÛŒÛŒ
          MESSAGE="ğŸ“¢ <b>JsonViewer.Blazor - Manual Notification</b>

$RELEASE_TYPE

ğŸ“¦ <b>Version:</b> <code>${TAG_NAME}</code>
ğŸ“ <b>Name:</b> ${NAME}
ğŸ“… <b>Published:</b> ${PUBLISHED_AT}

â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

<b>Release Notes:</b>
${BODY_HTML}

â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

ğŸ”— <b>Links:</b>
â€¢ <a href='${URL}'>View on GitHub</a>
â€¢ <a href='https://www.nuget.org/packages/JsonViewer.Blazor/${TAG_NAME}'>View on NuGet</a>

âš¡ <b>Install via:</b>
<code>dotnet add package JsonViewer.Blazor --version ${TAG_NAME}</code>"

          # Ø§Ú¯Ù‡ Ù¾ÛŒØ§Ù… Ø³ÙØ§Ø±Ø´ÛŒ Ø¯Ø§Ø´ØªÛŒÙ… Ø§Ø¶Ø§ÙÙ‡ Ú©Ù†
          if [ -n "$CUSTOM_MSG" ]; then
            MESSAGE="$MESSAGE

â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
ğŸ’¬ <i>${CUSTOM_MSG}</i>"
          fi

          MESSAGE="$MESSAGE

#JsonViewer #Blazor #DotNet #OpenSource"

          # Ø°Ø®ÛŒØ±Ù‡ Ù¾ÛŒØ§Ù… Ø¯Ø± ÙØ§ÛŒÙ„
          echo "$MESSAGE" > telegram_message.txt

          echo "âœ… Message prepared successfully!"

      # ========================================
      # 4ï¸âƒ£ Send to Telegram
      # ========================================
      - name: ğŸ“¤ Send to Telegram Channel
        env:
          TELEGRAM_BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
          TELEGRAM_CHAT_ID: ${{ secrets.TELEGRAM_CHAT_ID }}
        run: |
          MESSAGE=$(cat telegram_message.txt)

          echo "ğŸ“¤ Sending message to Telegram..."

          RESPONSE=$(curl -s -X POST "https://api.telegram.org/bot${TELEGRAM_BOT_TOKEN}/sendMessage" \
            -d "chat_id=${TELEGRAM_CHAT_ID}" \
            --data-urlencode "text=${MESSAGE}" \
            -d "parse_mode=HTML" \
            -d "disable_web_page_preview=false")

          if echo "$RESPONSE" | jq -e '.ok == true' > /dev/null; then
            echo "âœ… Message sent successfully!"
            echo "$RESPONSE" | jq '.result.message_id'
          else
            echo "âŒ Failed to send message!"
            echo "$RESPONSE" | jq '.'
            exit 1
          fi

      # ========================================
      # 5ï¸âƒ£ Summary
      # ========================================
      - name: ğŸ“Š Summary
        run: |
          echo "### âœ… Notification Sent Successfully!" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "ğŸ“¦ **Version:** \`${{ steps.latest_release.outputs.tag_name }}\`" >> $GITHUB_STEP_SUMMARY
          echo "ğŸ“ **Name:** ${{ steps.latest_release.outputs.name }}" >> $GITHUB_STEP_SUMMARY
          echo "ğŸ”— **Release URL:** ${{ steps.latest_release.outputs.url }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          if [ "${{ steps.latest_release.outputs.is_prerelease }}" == "true" ]; then
            echo "âš ï¸ **Type:** Pre-release" >> $GITHUB_STEP_SUMMARY
          else
            echo "âœ… **Type:** Stable" >> $GITHUB_STEP_SUMMARY
          fi
