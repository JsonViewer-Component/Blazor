name: ğŸ“¢ Manual Telegram Notification

on:
  workflow_dispatch:
    inputs:
      include_prerelease:
        description: 'Include pre-release versions?'
        required: false
        type: boolean
        default: true
      custom_message:
        description: 'Add custom message (optional)'
        required: false
        type: string

env:
  DOTNET_SKIP_FIRST_TIME_EXPERIENCE: 1
  DOTNET_NOLOGO: true

jobs:
  send-notification:
    name: ğŸ“± Send Manual Notification
    runs-on: ubuntu-latest

    permissions:
      contents: read

    steps:
      # ========================================
      # 1ï¸âƒ£ Checkout Repository
      # ========================================
      - name: ğŸ“¥ Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      # ========================================
      # 2ï¸âƒ£ Get Latest Release Info
      # ========================================
      - name: ğŸ” Fetch Latest Release
        id: latest_release
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          echo "ğŸ” Fetching latest release..."

          if [ "${{ inputs.include_prerelease }}" == "true" ]; then
            echo "ğŸ“¦ Including pre-release versions..."
            RELEASE_DATA=$(gh api repos/${{ github.repository }}/releases --jq '.[0]')
          else
            echo "ğŸ“¦ Stable releases only..."
            RELEASE_DATA=$(gh api repos/${{ github.repository }}/releases --jq '[.[] | select(.prerelease == false)][0]')
          fi

          if [ -z "$RELEASE_DATA" ] || [ "$RELEASE_DATA" == "null" ]; then
            echo "âŒ No release found!"
            exit 1
          fi

          # Extract info using jq
          TAG_NAME=$(echo "$RELEASE_DATA" | jq -r '.tag_name // empty')
          NAME=$(echo "$RELEASE_DATA" | jq -r '.name // empty')
          BODY=$(echo "$RELEASE_DATA" | jq -r '.body // empty')
          URL=$(echo "$RELEASE_DATA" | jq -r '.html_url // empty')
          IS_PRERELEASE=$(echo "$RELEASE_DATA" | jq -r '.prerelease // false')
          PUBLISHED_AT=$(echo "$RELEASE_DATA" | jq -r '.published_at // empty')

          # Extract version without 'v' prefix for NuGet
          VERSION="${TAG_NAME#v}"

          echo "âœ… Found release: $TAG_NAME (version: $VERSION)"

          # Save to outputs
          {
            echo "tag_name=$TAG_NAME"
            echo "version=$VERSION"
            echo "name=$NAME"
            echo "url=$URL"
            echo "is_prerelease=$IS_PRERELEASE"
            echo "published_at=$PUBLISHED_AT"
          } >> "$GITHUB_OUTPUT"

          # Save body to file (may be large)
          printf '%s' "$BODY" > release_body.txt

          echo "ğŸ“ Release body saved to file"

      # ========================================
      # 3ï¸âƒ£ Prepare Message for Telegram
      # ========================================
      - name: ğŸ“ Prepare Telegram Message
        id: prepare_message
        run: |
          TAG_NAME="${{ steps.latest_release.outputs.tag_name }}"
          VERSION="${{ steps.latest_release.outputs.version }}"
          NAME="${{ steps.latest_release.outputs.name }}"
          URL="${{ steps.latest_release.outputs.url }}"
          IS_PRERELEASE="${{ steps.latest_release.outputs.is_prerelease }}"
          PUBLISHED_AT="${{ steps.latest_release.outputs.published_at }}"
          CUSTOM_MSG="${{ inputs.custom_message }}"

          # Read body from file
          BODY=$(cat release_body.txt 2>/dev/null || echo "")

          # Convert Markdown to HTML (basic conversion)
          # Escape HTML special chars first
          BODY_HTML=$(echo "$BODY" | sed 's/&/\&amp;/g; s/</\&lt;/g; s/>/\&gt;/g')

          # Then convert markdown
          BODY_HTML=$(echo "$BODY_HTML" | \
            sed 's/^### \(.*\)$/<b>\1<\/b>/g' | \
            sed 's/^## \(.*\)$/<b>\1<\/b>/g' | \
            sed 's/^# \(.*\)$/<b>\1<\/b>/g' | \
            sed 's/\*\*\([^*]*\)\*\*/<b>\1<\/b>/g' | \
            sed 's/`\([^`]*\)`/<code>\1<\/code>/g')

          # Truncate if too long (Telegram limit: 4096 chars)
          if [ ${#BODY_HTML} -gt 1800 ]; then
            BODY_HTML="${BODY_HTML:0:1800}...

<i>(truncated - see full notes on GitHub)</i>"
          fi

          # Determine release type
          if [ "$IS_PRERELEASE" == "true" ]; then
            RELEASE_TYPE="âš ï¸ <b>Pre-release</b>"
          else
            RELEASE_TYPE="âœ… <b>Stable Release</b>"
          fi

          # Format published date
          if [ -n "$PUBLISHED_AT" ]; then
            FORMATTED_DATE=$(date -d "$PUBLISHED_AT" "+%Y-%m-%d %H:%M UTC" 2>/dev/null || echo "$PUBLISHED_AT")
          else
            FORMATTED_DATE="N/A"
          fi

          # Build final message
          cat > telegram_message.txt << 'MSGEOF'
ğŸ“¢ <b>JsonViewer.Blazor - Manual Notification</b>

MSGEOF

          cat >> telegram_message.txt << EOF
$RELEASE_TYPE

ğŸ“¦ <b>Version:</b> <code>${TAG_NAME}</code>
ğŸ“ <b>Name:</b> ${NAME}
ğŸ“… <b>Published:</b> ${FORMATTED_DATE}

â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

<b>ğŸ“‹ Release Notes:</b>
${BODY_HTML}

â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

ğŸ”— <b>Links:</b>
â€¢ <a href="${URL}">View on GitHub</a>
â€¢ <a href="https://www.nuget.org/packages/JsonViewer.Blazor/${VERSION}">View on NuGet</a>

âš¡ <b>Install via:</b>
<code>dotnet add package JsonViewer.Blazor --version ${VERSION}</code>
EOF

          # Add custom message if provided
          if [ -n "$CUSTOM_MSG" ]; then
            cat >> telegram_message.txt << EOF

â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
ğŸ’¬ <i>${CUSTOM_MSG}</i>
EOF
          fi

          # Add hashtags
          echo "" >> telegram_message.txt
          echo "#JsonViewer #Blazor #DotNet #OpenSource" >> telegram_message.txt

          echo "âœ… Message prepared successfully!"
          echo "ğŸ“ Message length: $(wc -c < telegram_message.txt) bytes"

      # ========================================
      # 4ï¸âƒ£ Send to Telegram
      # ========================================
      - name: ğŸ“¤ Send to Telegram Channel
        env:
          TELEGRAM_BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
          TELEGRAM_CHAT_ID: ${{ secrets.TELEGRAM_CHAT_ID }}
        run: |
          if [ -z "$TELEGRAM_BOT_TOKEN" ] || [ -z "$TELEGRAM_CHAT_ID" ]; then
            echo "âŒ Telegram credentials not configured!"
            echo "Please set TELEGRAM_BOT_TOKEN and TELEGRAM_CHAT_ID secrets."
            exit 1
          fi

          MESSAGE=$(cat telegram_message.txt)

          echo "ğŸ“¤ Sending message to Telegram..."

          # Send using curl with proper encoding
          RESPONSE=$(curl -s -w "\n%{http_code}" -X POST \
            "https://api.telegram.org/bot${TELEGRAM_BOT_TOKEN}/sendMessage" \
            -H "Content-Type: application/json" \
            -d "$(jq -n \
              --arg chat_id "$TELEGRAM_CHAT_ID" \
              --arg text "$MESSAGE" \
              '{
                chat_id: $chat_id,
                text: $text,
                parse_mode: "HTML",
                disable_web_page_preview: false
              }')")

          HTTP_CODE=$(echo "$RESPONSE" | tail -n1)
          BODY=$(echo "$RESPONSE" | sed '$d')

          if [ "$HTTP_CODE" -eq 200 ] && echo "$BODY" | jq -e '.ok == true' > /dev/null 2>&1; then
            echo "âœ… Message sent successfully!"
            MESSAGE_ID=$(echo "$BODY" | jq -r '.result.message_id')
            echo "ğŸ“¨ Message ID: $MESSAGE_ID"
          else
            echo "âŒ Failed to send message!"
            echo "HTTP Code: $HTTP_CODE"
            echo "Response: $BODY"
            exit 1
          fi

      # ========================================
      # 5ï¸âƒ£ Summary
      # ========================================
      - name: ğŸ“Š Summary
        if: always()
        run: |
          {
            echo "## ğŸ“¢ Telegram Notification Summary"
            echo ""
            echo "### ğŸ“¦ Release Info"
            echo "| Property | Value |"
            echo "|----------|-------|"
            echo "| **Tag** | \`${{ steps.latest_release.outputs.tag_name }}\` |"
            echo "| **Version** | \`${{ steps.latest_release.outputs.version }}\` |"
            echo "| **Name** | ${{ steps.latest_release.outputs.name }} |"
            echo "| **Type** | ${{ steps.latest_release.outputs.is_prerelease == 'true' && 'âš ï¸ Pre-release' || 'âœ… Stable' }} |"
            echo ""
            echo "### ğŸ”— Links"
            echo "- [GitHub Release](${{ steps.latest_release.outputs.url }})"
            echo "- [NuGet Package](https://www.nuget.org/packages/JsonViewer.Blazor/${{ steps.latest_release.outputs.version }})"
          } >> "$GITHUB_STEP_SUMMARY"
