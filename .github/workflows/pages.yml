name: ğŸš€ Deploy Blazor to GitHub Pages

on:
  push:
    branches: [ main ]
    paths:
      - 'src/**'
      - 'samples/BlazorWasm.NET8/**'
      - 'Documents/**'
  workflow_dispatch:

permissions:
  contents: read
  pages: write
  id-token: write

concurrency:
  group: "pages"
  cancel-in-progress: false

jobs:
  build:
    runs-on: ubuntu-latest
    
    steps:
    - name: ğŸ“¥ Checkout repository
      uses: actions/checkout@v4
    
    - name: ğŸ”§ Setup .NET 8
      uses: actions/setup-dotnet@v4
      with:
        dotnet-version: '8.0.x'
    
    - name: ğŸ“¦ Restore dependencies
      run: dotnet restore samples/BlazorWasm.NET8/BlazorWasm.NET8.csproj
    
    - name: ğŸ—ï¸ Build Blazor WebAssembly
      run: dotnet publish samples/BlazorWasm.NET8/BlazorWasm.NET8.csproj -c Release -o output
    
    - name: ğŸ”§ Fix base href for GitHub Pages
      run: |
        sed -i 's/<base href="\/" \/>/<base href="\/blazor\/" \/>/g' output/wwwroot/index.html
    
    - name: ğŸ“ Prepare GitHub Pages structure
      run: |
        # Ø§ÛŒØ¬Ø§Ø¯ Ù¾ÙˆØ´Ù‡ Ù…ÙˆÙ‚Øª Ø¨Ø±Ø§ÛŒ Pages
        mkdir -p _site
        
        # Ú©Ù¾ÛŒ ØµÙØ­Ù‡ Ø§ØµÙ„ÛŒ Ø§Ø² Documents (Ø§Ú¯Ø± ÙˆØ¬ÙˆØ¯ Ø¯Ø§Ø´ØªÙ‡ Ø¨Ø§Ø´Ø¯)
        if [ -f "Documents/index.html" ]; then
          cp Documents/index.html _site/
        else
          # Ø§ÛŒØ¬Ø§Ø¯ ØµÙØ­Ù‡ Ù¾ÛŒØ´â€ŒÙØ±Ø¶
          cat > _site/index.html << 'EOF'
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="refresh" content="0; url=./demo/">
    <title>JsonViewer Blazor Demo</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100vh;
            margin: 0;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }
        .container {
            text-align: center;
        }
        h1 { font-size: 3em; margin-bottom: 20px; }
        a {
            display: inline-block;
            padding: 15px 30px;
            background: white;
            color: #667eea;
            text-decoration: none;
            border-radius: 8px;
            font-weight: 600;
            transition: transform 0.2s;
        }
        a:hover { transform: scale(1.05); }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸš€ JsonViewer Blazor</h1>
        <p>Redirecting to demo...</p>
        <a href="./demo/">Go to Demo â†’</a>
    </div>
</body>
</html>
EOF
        fi
        
        # Ú©Ù¾ÛŒ ÙØ§ÛŒÙ„â€ŒÙ‡Ø§ÛŒ Ø§Ø³ØªØ§ØªÛŒÚ© Ø§Ø¶Ø§ÙÛŒ Ø§Ø² Documents (Ø§Ú¯Ø± Ø¯Ø§Ø±ÛŒ)
        if [ -d "Documents/assets" ]; then
          cp -r Documents/assets _site/
        fi
        
        # Ú©Ù¾ÛŒ Ø¯Ù…Ùˆ Blazor Ø¨Ù‡ Ù¾ÙˆØ´Ù‡ demo
        mkdir -p _site/demo
        cp -r output/wwwroot/* _site/demo/
        
        # âœ… Ø§Ø¶Ø§ÙÙ‡ Ú©Ø±Ø¯Ù† .nojekyll Ø¨Ø±Ø§ÛŒ ØºÛŒØ±ÙØ¹Ø§Ù„ Ú©Ø±Ø¯Ù† Jekyll
        touch _site/.nojekyll
        
        # Ù†Ù…Ø§ÛŒØ´ Ø³Ø§Ø®ØªØ§Ø± Ù†Ù‡Ø§ÛŒÛŒ
        echo "ğŸ“‚ Final structure:"
        ls -la _site/
        echo "ğŸ“‚ Demo folder:"
        ls -la _site/demo/ | head -n 10
    
    - name: ğŸ”§ Setup GitHub Pages
      uses: actions/configure-pages@v4
    
    - name: ğŸ“¤ Upload Pages artifact
      uses: actions/upload-pages-artifact@v3
      with:
        path: '_site'

  deploy:
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}
    runs-on: ubuntu-latest
    needs: build
    
    steps:
    - name: ğŸš€ Deploy to GitHub Pages
      id: deployment
      uses: actions/deploy-pages@v4
