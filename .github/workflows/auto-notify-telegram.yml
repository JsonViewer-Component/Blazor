name: Auto Telegram Notification

on:
  workflow_run:
    workflows: ["ðŸ“¦ Publish Package"]
    types:
      - completed

env:
  DOTNET_SKIP_FIRST_TIME_EXPERIENCE: 1
  DOTNET_NOLOGO: true

jobs:
  notify:
    name: Send Release Notification
    runs-on: ubuntu-latest
    if: ${{ github.event.workflow_run.conclusion == 'success' }}

    permissions:
      contents: read

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Get Release Info
        id: release_info
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          echo "Fetching latest release..."

          RELEASE_DATA=$(gh api repos/${{ github.repository }}/releases --jq '.[0]')

          if [ -z "$RELEASE_DATA" ] || [ "$RELEASE_DATA" == "null" ]; then
            echo "No release found!"
            exit 1
          fi

          TAG_NAME=$(echo "$RELEASE_DATA" | jq -r '.tag_name // empty')
          NAME=$(echo "$RELEASE_DATA" | jq -r '.name // empty')
          BODY=$(echo "$RELEASE_DATA" | jq -r '.body // empty')
          URL=$(echo "$RELEASE_DATA" | jq -r '.html_url // empty')
          IS_PRERELEASE=$(echo "$RELEASE_DATA" | jq -r '.prerelease // false')
          PUBLISHED_AT=$(echo "$RELEASE_DATA" | jq -r '.published_at // empty')

          VERSION="${TAG_NAME#v}"

          echo "Found release: $TAG_NAME (version: $VERSION)"

          echo "tag_name=$TAG_NAME" >> "$GITHUB_OUTPUT"
          echo "version=$VERSION" >> "$GITHUB_OUTPUT"
          echo "name=$NAME" >> "$GITHUB_OUTPUT"
          echo "url=$URL" >> "$GITHUB_OUTPUT"
          echo "is_prerelease=$IS_PRERELEASE" >> "$GITHUB_OUTPUT"
          echo "published_at=$PUBLISHED_AT" >> "$GITHUB_OUTPUT"

          printf '%s' "$BODY" > release_body.txt
          echo "Release body saved to file"

      - name: Prepare Telegram Message
        id: prepare_message
        run: |
          TAG_NAME="${{ steps.release_info.outputs.tag_name }}"
          VERSION="${{ steps.release_info.outputs.version }}"
          NAME="${{ steps.release_info.outputs.name }}"
          URL="${{ steps.release_info.outputs.url }}"
          IS_PRERELEASE="${{ steps.release_info.outputs.is_prerelease }}"
          PUBLISHED_AT="${{ steps.release_info.outputs.published_at }}"

          BODY=$(cat release_body.txt 2>/dev/null || echo "")

          # Escape HTML special chars
          BODY_HTML=$(echo "$BODY" | sed 's/&/\&amp;/g; s/</\&lt;/g; s/>/\&gt;/g')

          # Convert markdown to HTML
          BODY_HTML=$(echo "$BODY_HTML" | \
            sed 's/^### \(.*\)$/<b>\1<\/b>/g' | \
            sed 's/^## \(.*\)$/<b>\1<\/b>/g' | \
            sed 's/^# \(.*\)$/<b>\1<\/b>/g' | \
            sed 's/\*\*\([^*]*\)\*\*/<b>\1<\/b>/g' | \
            sed 's/`\([^`]*\)`/<code>\1<\/code>/g')

          # Truncate if too long
          if [ ${#BODY_HTML} -gt 1800 ]; then
            BODY_HTML="${BODY_HTML:0:1800}... (truncated)"
          fi

          if [ "$IS_PRERELEASE" == "true" ]; then
            RELEASE_TYPE="Pre-release"
          else
            RELEASE_TYPE="Stable Release"
          fi

          if [ -n "$PUBLISHED_AT" ]; then
            FORMATTED_DATE=$(date -d "$PUBLISHED_AT" "+%Y-%m-%d %H:%M UTC" 2>/dev/null || echo "$PUBLISHED_AT")
          else
            FORMATTED_DATE="N/A"
          fi

          # Build message
          cat > telegram_message.txt << MSGEOF
JsonViewer.Blazor - New Release Published!

${RELEASE_TYPE}

Version: ${TAG_NAME}
Name: ${NAME}
Published: ${FORMATTED_DATE}

Release Notes:
${BODY_HTML}

Links:
- GitHub: ${URL}
- NuGet: https://www.nuget.org/packages/JsonViewer.Blazor/${VERSION}

Install:
dotnet add package JsonViewer.Blazor --version ${VERSION}

#JsonViewer #Blazor #DotNet #OpenSource
MSGEOF

          echo "Message prepared successfully!"
          echo "Message length: $(wc -c < telegram_message.txt) bytes"

      - name: Send to Telegram Channel
        env:
          TELEGRAM_BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
          TELEGRAM_CHAT_ID: ${{ secrets.TELEGRAM_CHAT_ID }}
        run: |
          if [ -z "$TELEGRAM_BOT_TOKEN" ] || [ -z "$TELEGRAM_CHAT_ID" ]; then
            echo "Telegram credentials not configured!"
            echo "Please set TELEGRAM_BOT_TOKEN and TELEGRAM_CHAT_ID secrets."
            exit 1
          fi

          MESSAGE=$(cat telegram_message.txt)

          echo "Sending message to Telegram..."

          RESPONSE=$(curl -s -w "\n%{http_code}" -X POST \
            "https://api.telegram.org/bot${TELEGRAM_BOT_TOKEN}/sendMessage" \
            -H "Content-Type: application/json" \
            -d "$(jq -n \
              --arg chat_id "$TELEGRAM_CHAT_ID" \
              --arg text "$MESSAGE" \
              '{chat_id: $chat_id, text: $text, parse_mode: "HTML", disable_web_page_preview: false}')")

          HTTP_CODE=$(echo "$RESPONSE" | tail -n1)
          RESP_BODY=$(echo "$RESPONSE" | sed '$d')

          if [ "$HTTP_CODE" -eq 200 ] && echo "$RESP_BODY" | jq -e '.ok == true' > /dev/null 2>&1; then
            echo "Message sent successfully!"
            MESSAGE_ID=$(echo "$RESP_BODY" | jq -r '.result.message_id')
            echo "Message ID: $MESSAGE_ID"
          else
            echo "Failed to send message!"
            echo "HTTP Code: $HTTP_CODE"
            echo "Response: $RESP_BODY"
            exit 1
          fi

      - name: Summary
        if: always()
        run: |
          echo "## Telegram Notification Summary" >> "$GITHUB_STEP_SUMMARY"
          echo "" >> "$GITHUB_STEP_SUMMARY"
          echo "### Release Info" >> "$GITHUB_STEP_SUMMARY"
          echo "| Property | Value |" >> "$GITHUB_STEP_SUMMARY"
          echo "|----------|-------|" >> "$GITHUB_STEP_SUMMARY"
          echo "| **Tag** | ${{ steps.release_info.outputs.tag_name }} |" >> "$GITHUB_STEP_SUMMARY"
          echo "| **Version** | ${{ steps.release_info.outputs.version }} |" >> "$GITHUB_STEP_SUMMARY"
          echo "| **Name** | ${{ steps.release_info.outputs.name }} |" >> "$GITHUB_STEP_SUMMARY"
          if [ "${{ steps.release_info.outputs.is_prerelease }}" == "true" ]; then
            echo "| **Type** | Pre-release |" >> "$GITHUB_STEP_SUMMARY"
          else
            echo "| **Type** | Stable |" >> "$GITHUB_STEP_SUMMARY"
          fi
          echo "" >> "$GITHUB_STEP_SUMMARY"
          echo "### Links" >> "$GITHUB_STEP_SUMMARY"
          echo "- [GitHub Release](${{ steps.release_info.outputs.url }})" >> "$GITHUB_STEP_SUMMARY"
          echo "- [NuGet Package](https://www.nuget.org/packages/JsonViewer.Blazor/${{ steps.release_info.outputs.version }})" >> "$GITHUB_STEP_SUMMARY"
          echo "" >> "$GITHUB_STEP_SUMMARY"
          echo "### Trigger Info" >> "$GITHUB_STEP_SUMMARY"
          echo "- Triggered by: **${{ github.event.workflow_run.name }}**" >> "$GITHUB_STEP_SUMMARY"
          echo "- Workflow Run: [#${{ github.event.workflow_run.run_number }}](${{ github.event.workflow_run.html_url }})" >> "$GITHUB_STEP_SUMMARY"

