name: Manual LinkedIn Notification

on:
  workflow_dispatch:
    inputs:
      include_prerelease:
        description: 'Include pre-release versions?'
        required: false
        type: boolean
        default: true

env:
  DOTNET_SKIP_FIRST_TIME_EXPERIENCE: 1
  DOTNET_NOLOGO: true

jobs:
  send-notification:
    name: Send Manual LinkedIn Notification
    runs-on: ubuntu-latest
    permissions:
      contents: read

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Fetch Latest Release
        id: release
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          echo "Fetching latest release..."

          if [ "${{ inputs.include_prerelease }}" == "true" ]; then
            echo "Including pre-release versions..."
            RELEASE=$(gh api repos/${{ github.repository }}/releases --jq '.[0]')
          else
            echo "Stable releases only..."
            RELEASE=$(gh api repos/${{ github.repository }}/releases --jq '[.[] | select(.prerelease == false)][0]')
          fi

          if [ -z "$RELEASE" ] || [ "$RELEASE" == "null" ]; then
            echo "No release found!"
            exit 1
          fi

          TAG=$(echo "$RELEASE" | jq -r '.tag_name // empty')
          NAME=$(echo "$RELEASE" | jq -r '.name // empty')
          BODY=$(echo "$RELEASE" | jq -r '.body // empty')
          URL=$(echo "$RELEASE" | jq -r '.html_url // empty')
          VERSION="${TAG#v}"

          echo "Found release: $TAG (version: $VERSION)"

          echo "tag=$TAG" >> "$GITHUB_OUTPUT"
          echo "version=$VERSION" >> "$GITHUB_OUTPUT"
          echo "name=$NAME" >> "$GITHUB_OUTPUT"
          echo "url=$URL" >> "$GITHUB_OUTPUT"

          # Save original release body (keep emojis and markdown)
          echo "$BODY" > release_body.txt
          echo "Release body saved (preserving emojis and markdown)"

      - name: Create Post Message
        id: message
        run: |
          TAG="${{ steps.release.outputs.tag }}"
          VERSION="${{ steps.release.outputs.version }}"
          NAME="${{ steps.release.outputs.name }}"
          URL="${{ steps.release.outputs.url }}"

          # Get current date and time for uniqueness
          TIMESTAMP=$(date -u +"%Y-%m-%d %H:%M UTC")
          DATE_ONLY=$(date -u +"%B %d, %Y")
          TIME_ONLY=$(date -u +"%H:%M UTC")

          # Read original release body (with emojis and markdown)
          RELEASE_BODY=$(cat release_body.txt 2>/dev/null || echo "")

          # LinkedIn supports markdown, so we keep it
          # But we need to clean up some markdown that LinkedIn doesn't support well
          # Remove HTML comments and code blocks markers if they cause issues
          CLEANED_BODY=$(echo "$RELEASE_BODY" | \
            sed 's/<!--.*-->//g' | \
            sed '/^```/,/^```/d' | \
            sed 's/^---$//g')

          # Truncate if too long (LinkedIn limit: 3000 chars, but we keep some margin)
          # Reserve space for timestamp at the end
          BODY_LENGTH=${#CLEANED_BODY}
          if [ $BODY_LENGTH -gt 2400 ]; then
            CLEANED_BODY="${CLEANED_BODY:0:2400}...\n\nðŸ“– See full release notes on GitHub."
          fi

          # Create LinkedIn post with header and release body
          # Add timestamp at the end to make each post unique
          {
            printf 'ðŸš€ JsonViewer.Blazor %s Released!\n\n' "$TAG"
            printf '%s\n\n' "$CLEANED_BODY"
            printf 'â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\n\n'
            printf 'ðŸ“¦ Install:\n'
            printf '```\n'
            printf 'dotnet add package JsonViewer.Blazor --version %s\n' "$VERSION"
            printf '```\n\n'
            printf 'ðŸ”— Links:\n'
            printf 'â€¢ ðŸ“š GitHub: %s\n' "$URL"
            printf 'â€¢ ðŸ“¦ NuGet: https://www.nuget.org/packages/JsonViewer.Blazor/%s\n\n' "$VERSION"
            printf 'ðŸ“… Posted: %s\n\n' "$TIMESTAMP"
            printf '#JsonViewer #Blazor #DotNet #OpenSource #CSharp #WebDevelopment'
          } > message.txt

          # Read message and encode for JSON
          MESSAGE_CONTENT=$(cat message.txt)
          MESSAGE_ENCODED=$(echo "$MESSAGE_CONTENT" | jq -Rs .)
          echo "encoded=$MESSAGE_ENCODED" >> "$GITHUB_OUTPUT"
          echo "timestamp=$TIMESTAMP" >> "$GITHUB_OUTPUT"

          echo "Message prepared successfully!"
          echo "Message length: $(wc -c < message.txt) bytes"
          echo "Body length: $BODY_LENGTH characters"
          echo "Timestamp: $TIMESTAMP"

      - name: Send to Make.com
        env:
          MAKE_WEBHOOK_URL: ${{ secrets.MAKE_WEBHOOK_URL }}
        run: |
          if [ -z "$MAKE_WEBHOOK_URL" ]; then
            echo "Make.com webhook URL not configured!"
            echo "Please set MAKE_WEBHOOK_URL secret."
            exit 1
          fi

          TAG="${{ steps.release.outputs.tag }}"
          URL="${{ steps.release.outputs.url }}"
          WORKFLOW_RUN_ID="${{ github.run_id }}"
          WORKFLOW_RUN_NUMBER="${{ github.run_number }}"
          TIMESTAMP=$(date -u +"%Y-%m-%dT%H:%M:%SZ")

          # Create a unique hash of the message content for duplicate detection
          MESSAGE_HASH=$(cat message.txt | sha256sum | cut -d' ' -f1 | cut -c1-16)

          # Read message from file and encode it properly
          MESSAGE_CONTENT=$(cat message.txt)
          MESSAGE_ENCODED=$(echo "$MESSAGE_CONTENT" | jq -Rs .)

          echo "Sending to Make.com webhook..."
          echo "Release: $TAG"
          echo "Workflow Run: #$WORKFLOW_RUN_NUMBER (ID: $WORKFLOW_RUN_ID)"
          echo "Timestamp: $TIMESTAMP"
          echo "Message Hash: $MESSAGE_HASH"
          echo ""
          echo "â„¹ï¸ Note: LinkedIn may reject duplicate posts with identical content."
          echo "â„¹ï¸ If this is a duplicate, Make.com should handle it gracefully."

          # Build JSON payload with comprehensive duplicate detection info
          # Make.com can use release_tag as unique identifier to prevent duplicates
          JSON_PAYLOAD=$(jq -n \
            --argjson message "$MESSAGE_ENCODED" \
            --arg version "$TAG" \
            --arg url "$URL" \
            --arg run_id "$WORKFLOW_RUN_ID" \
            --arg run_number "$WORKFLOW_RUN_NUMBER" \
            --arg timestamp "$TIMESTAMP" \
            --arg release_tag "$TAG" \
            --arg message_hash "$MESSAGE_HASH" \
            '{
              message: $message,
              version: $version,
              url: $url,
              metadata: {
                workflow_run_id: $run_id,
                workflow_run_number: $run_number,
                timestamp: $timestamp,
                release_tag: $release_tag,
                message_hash: $message_hash,
                duplicate_check_key: $release_tag,
                is_duplicate_check: true
              }
            }')

          RESPONSE=$(curl -s -w "\n%{http_code}" -X POST "$MAKE_WEBHOOK_URL" \
            -H "Content-Type: application/json" \
            -d "$JSON_PAYLOAD")

          HTTP_CODE=$(echo "$RESPONSE" | tail -n1)
          RESP_BODY=$(echo "$RESPONSE" | sed '$d')

          if [ "$HTTP_CODE" -eq 200 ] || [ "$HTTP_CODE" -eq 201 ] || [ "$HTTP_CODE" -eq 202 ]; then
            echo "âœ… Message sent successfully to Make.com!"
            echo "HTTP Code: $HTTP_CODE"
            if [ -n "$RESP_BODY" ]; then
              echo "Response: $RESP_BODY"
            fi
          else
            echo "âš ï¸ HTTP Code: $HTTP_CODE"
            echo "Response: $RESP_BODY"
            echo ""

            # Check if it's a duplicate/rate limit error
            if echo "$RESP_BODY" | grep -qiE "duplicate|rate.limit|already.posted|rejected|spam|identical"; then
              echo "â„¹ï¸ This appears to be a duplicate post or rate limit issue."
              echo "â„¹ï¸ LinkedIn typically rejects duplicate content to prevent spam."
              echo "â„¹ï¸ This is expected behavior - only the first post will be published."
              echo "â„¹ï¸ Workflow will succeed to avoid false failures."
              # Don't fail the workflow for duplicates - this is expected
              exit 0
            elif [ "$HTTP_CODE" -eq 429 ]; then
              echo "âš ï¸ Rate limit exceeded (429)."
              echo "â„¹ï¸ LinkedIn has rate limits. Please wait before retrying."
              echo "â„¹ï¸ Workflow will succeed to avoid false failures."
              exit 0
            else
              echo "âŒ Failed to send message with unexpected error!"
              echo "âŒ Please check Make.com webhook configuration."
              exit 1
            fi
          fi

      - name: Summary
        if: always()
        run: |
          echo "## LinkedIn Notification Summary" >> "$GITHUB_STEP_SUMMARY"
          echo "" >> "$GITHUB_STEP_SUMMARY"
          echo "### Release Info" >> "$GITHUB_STEP_SUMMARY"
          echo "| Property | Value |" >> "$GITHUB_STEP_SUMMARY"
          echo "|----------|-------|" >> "$GITHUB_STEP_SUMMARY"
          echo "| **Tag** | ${{ steps.release.outputs.tag }} |" >> "$GITHUB_STEP_SUMMARY"
          echo "| **Version** | ${{ steps.release.outputs.version }} |" >> "$GITHUB_STEP_SUMMARY"
          echo "| **Name** | ${{ steps.release.outputs.name }} |" >> "$GITHUB_STEP_SUMMARY"
          echo "" >> "$GITHUB_STEP_SUMMARY"
          echo "### Links" >> "$GITHUB_STEP_SUMMARY"
          echo "- [GitHub Release](${{ steps.release.outputs.url }})" >> "$GITHUB_STEP_SUMMARY"
          echo "- [NuGet Package](https://www.nuget.org/packages/JsonViewer.Blazor/${{ steps.release.outputs.version }})" >> "$GITHUB_STEP_SUMMARY"
          echo "" >> "$GITHUB_STEP_SUMMARY"
          echo "### ðŸ“ Note About Duplicates" >> "$GITHUB_STEP_SUMMARY"
          echo "" >> "$GITHUB_STEP_SUMMARY"
          echo "LinkedIn rejects duplicate posts to prevent spam. If you run this workflow multiple times for the same release:" >> "$GITHUB_STEP_SUMMARY"
          echo "- âœ… First run: Will post successfully" >> "$GITHUB_STEP_SUMMARY"
          echo "- âš ï¸ Subsequent runs: May be rejected (this is expected)" >> "$GITHUB_STEP_SUMMARY"
          echo "" >> "$GITHUB_STEP_SUMMARY"
          echo "**To prevent duplicates in Make.com:**" >> "$GITHUB_STEP_SUMMARY"
          echo "1. Use \`metadata.release_tag\` as unique identifier" >> "$GITHUB_STEP_SUMMARY"
          echo "2. Check if post already exists before posting to LinkedIn" >> "$GITHUB_STEP_SUMMARY"
          echo "3. Use Make.com's 'Filter' or 'Router' module to skip duplicates" >> "$GITHUB_STEP_SUMMARY"
          echo "" >> "$GITHUB_STEP_SUMMARY"
          echo "### Message Preview:" >> "$GITHUB_STEP_SUMMARY"
          echo "\`\`\`" >> "$GITHUB_STEP_SUMMARY"
          cat message.txt >> "$GITHUB_STEP_SUMMARY"
          echo "\`\`\`" >> "$GITHUB_STEP_SUMMARY"
