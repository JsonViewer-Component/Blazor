@using Microsoft.JSInterop
@inject IJSRuntime jsRuntime

<button @onclick="ToggleTheme"
        class="btn btn-sm btn-light mb-2 toggle-theme-btn @GetThemeClass()"
        title="@GetTooltip()">
    <Icon Name="@GetIconName()" Size="18" />
</button>

@code {
    [Parameter]
    public bool IsDark { get; set; } = true;

    [Parameter]
    public EventCallback<bool> OnThemeChanged { get; set; }

    protected override async Task OnInitializedAsync()
    {
        try
        {
            // Search all session keys containing 'theme'
            var detectedTheme = await jsRuntime.InvokeAsync<string>("eval", @"
                (function() {
                    // Priority 1: component's own session
                    const ownTheme = localStorage.getItem('json-viewer-theme');
                    if (ownTheme) return ownTheme;

                    // Priority 2: search all keys
                    for (let i = 0; i < localStorage.length; i++) {
                        const key = localStorage.key(i);
                        if (key && (key.toLowerCase().includes('theme'))) {
                            const value = localStorage.getItem(key);
                            // Only valid values
                            if (value === 'light' || value === 'Light' ||
                                value === 'dark' || value === 'Dark') {
                                return value;
                            }
                        }
                    }

                    // Default
                    return 'dark';
                })()
            ");

            // Normalize value
            if (!string.IsNullOrEmpty(detectedTheme))
            {
                IsDark = detectedTheme.ToLower() == "dark";

                // Save in component's own session
                await jsRuntime.InvokeVoidAsync("localStorage.setItem",
                    "json-viewer-theme", IsDark ? "dark" : "light");

                // Notify JsonViewer
                if (OnThemeChanged.HasDelegate)
                {
                    await OnThemeChanged.InvokeAsync(IsDark);
                }
            }
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error loading theme: {ex.Message}");
            IsDark = true; // Default dark
        }
    }

    private async Task ToggleTheme()
    {
        var newTheme = !IsDark;
        var themeValue = newTheme ? "dark" : "light";

        try
        {
            // Update all session keys containing 'theme'
            await jsRuntime.InvokeVoidAsync("eval", $@"
                (function() {{
                    // List all keys containing theme
                    const themeKeys = [];
                    for (let i = 0; i < localStorage.length; i++) {{
                        const key = localStorage.key(i);
                        if (key && (key.toLowerCase().includes('theme'))) {{
                            themeKeys.push(key);
                        }}
                    }}

                    // Update all
                    themeKeys.forEach(key => {{
                        localStorage.setItem(key, '{themeValue}');
                    }});

                    // If json-viewer-theme session doesn't exist, create it
                    if (!themeKeys.includes('json-viewer-theme')) {{
                        localStorage.setItem('json-viewer-theme', '{themeValue}');
                    }}
                }})()
            ");
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error syncing theme: {ex.Message}");
        }

        // Notify JsonViewer
        if (OnThemeChanged.HasDelegate)
        {
            await OnThemeChanged.InvokeAsync(newTheme);
        }
    }

    private string GetIconName() => IsDark ? "sun-fill" : "moon-fill";

    private string GetTooltip() => IsDark ? "Switch to Light Theme" : "Switch to Dark Theme";

    private string GetThemeClass() => IsDark ? "theme-dark" : "theme-light";
}

<style>
    .toggle-theme-btn {
        transition: all 0.3s ease;
        width: 100%;
    }

        .toggle-theme-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
        }

        .toggle-theme-btn.theme-dark {
            background-color: #1e1e1e !important;
            border-color: #3c3c3c !important;
            color: #fdb813 !important;
        }

        .toggle-theme-btn.theme-light {
            background-color: #ffffff !important;
            border-color: #dee2e6 !important;
            color: #4a90e2 !important;
        }
</style>
