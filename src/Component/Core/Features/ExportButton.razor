@using Component.Core.Shared
@using Component.Services
@using System.Text
@using System.Text.Json.Nodes
@using System.Text.Json
@inject IOptimizedFileDownloadService FileDownloadService

<button @onclick="HandleExportClick"
        class="@ButtonClass"
        title="@Title"
        disabled="@IsDisabled">
    <Icon Name="@IconName" />
    @if (!string.IsNullOrEmpty(ButtonText))
    {
        <span class="ms-1">@ButtonText</span>
    }
    @if (isExporting)
    {
        <span class="spinner-border spinner-border-sm ms-1" role="status">
            <span class="visually-hidden">Exporting...</span>
        </span>
    }
</button>

@code {
    #region Parameters

    /// <summary>
    /// JsonNode from JsonViewer (System.Text.Json)
    /// </summary>
    [Parameter]
    public JsonNode? JsonToken { get; set; }

    /// <summary>
    /// JSON Data as String
    /// </summary>
    [Parameter]
    public string? JsonData { get; set; }

    /// <summary>
    /// File name prefix
    /// </summary>
    [Parameter]
    public string FileNamePrefix { get; set; } = "json_export";

    /// <summary>
    /// Notification event
    /// </summary>
    [Parameter]
    public EventCallback<(string message, string type)> OnNotification { get; set; }

    #endregion

    #region UI Customization

    /// <summary>
    /// Button tooltip title
    /// </summary>
    [Parameter]
    public string Title { get; set; } = "Export to file";

    /// <summary>
    /// Button CSS classes
    /// </summary>
    [Parameter]
    public string ButtonClass { get; set; } = "btn btn-sm btn-light mb-2";

    /// <summary>
    /// Icon name
    /// </summary>
    [Parameter]
    public string IconName { get; set; } = "download";

    /// <summary>
    /// Optional text next to icon
    /// </summary>
    [Parameter]
    public string ButtonText { get; set; } = string.Empty;

    #endregion

    #region Private Fields

    private bool isExporting = false;
    private const int LARGE_FILE_THRESHOLD = 5 * 1024 * 1024;

    /// <summary>
    /// Button enabled/disabled state
    /// </summary>
    private bool IsDisabled => (JsonToken == null && string.IsNullOrEmpty(JsonData)) || isExporting;

    #endregion

    #region Main Methods

    /// <summary>
    /// Handle Export button click
    /// </summary>
    private async Task HandleExportClick()
    {
        // Check for empty data
        if (JsonToken == null && string.IsNullOrEmpty(JsonData))
            return;

        isExporting = true;
        StateHasChanged();

        try
        {
            // Get content and filename
            var content = GetExportContent();
            var fileName = GetExportFileName();
            var fullFileName = $"{fileName}.json";
            var contentSize = Encoding.UTF8.GetByteCount(content);

            // Auto-detect for large files
            if (contentSize > LARGE_FILE_THRESHOLD)
            {
                await FileDownloadService.DownloadLargeFileAsync(
                    fullFileName,
                    content,
                    "application/json",
                    chunkSize: 1024 * 1024
                );
            }
            else
            {
                await FileDownloadService.DownloadFileAsync(
                    fullFileName,
                    content,
                    "application/json"
                );
            }

            // Success notification
            await SendNotification(
                $"File '{fullFileName}' ({FormatBytes(contentSize)}) exported successfully",
                "success"
            );
        }
        catch (Exception ex)
        {
            // Error notification
            await SendNotification(
                $"Failed to export: {ex.Message}",
                "error"
            );

            Console.WriteLine($"Export error: {ex}");
        }
        finally
        {
            isExporting = false;
            StateHasChanged();
        }
    }

    #endregion

    #region Helper Methods

    /// <summary>
    /// Get formatted JSON content for export
    /// </summary>
    private string GetExportContent()
    {
        if (JsonToken != null)
        {
            // Use System.Text.Json
            var options = new JsonSerializerOptions
            {
                WriteIndented = true
            };

            return JsonToken.ToJsonString(options);
        }

        return JsonData ?? string.Empty;
    }

    /// <summary>
    /// Generate filename with timestamp
    /// </summary>
    private string GetExportFileName()
    {
        var timestamp = DateTime.Now.ToString("yyyyMMdd_HHmmss");
        return $"{FileNamePrefix}_{timestamp}";
    }

    /// <summary>
    /// Send notification message to parent component
    /// </summary>
    private async Task SendNotification(string message, string type)
    {
        if (OnNotification.HasDelegate)
        {
            await OnNotification.InvokeAsync((message, type));
        }
    }

    /// <summary>
    /// Convert bytes to readable format
    /// </summary>
    private string FormatBytes(long bytes)
    {
        string[] suffixes = { "B", "KB", "MB", "GB", "TB" };
        int counter = 0;
        decimal number = bytes;

        while (Math.Round(number / 1024) >= 1 && counter < suffixes.Length - 1)
        {
            number /= 1024;
            counter++;
        }

        return $"{number:n1} {suffixes[counter]}";
    }

    #endregion
}
