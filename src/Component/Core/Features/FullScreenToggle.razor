@using Microsoft.JSInterop
@inject IJSRuntime JSRuntime

<button @onclick="@HandleToggleFullScreen"
        class="btn btn-sm btn-light mb-2 fullscreen-btn"
        title="@(IsFullScreen ? "Exit Full Screen (Esc)" : "Enter Full Screen (F11)")">
    <Icon Name="@(IsFullScreen ? "fullscreen-exit" : "arrows-fullscreen")" />
</button>

@code {
    #region Parameters

    [Parameter]
    public bool IsFullScreen { get; set; }

    [Parameter]
    public EventCallback<bool> OnFullScreenChanged { get; set; }

    [Parameter]
    public bool IsDarkTheme { get; set; }

    [Parameter]
    public EventCallback<(string message, string type)> OnNotification { get; set; }

    #endregion

    #region Lifecycle

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
        {
            await JSRuntime.InvokeVoidAsync("eval", @"
                (function() {
                    if (window.jsonViewerFullScreenInitialized) return;

                    window.jsonViewerFullScreenState = {
                        originalContainerStyle: null,
                        originalBodyOverflow: null,
                        originalBodyPosition: null,
                        originalBodyWidth: null,
                        originalBodyHeight: null,
                        originalCardStyle: null,
                        originalCardBodyStyle: null,
                        originalRowStyle: null,
                        originalColStyle: null,
                        originalParent: null,
                        originalNextSibling: null,
                        scrollPosition: 0,
                        isFullScreen: false
                    };

                    window.enterJsonViewerFullScreen = function(isDarkTheme) {
                        const state = window.jsonViewerFullScreenState;
                        const container = document.querySelector('.json-viewer-container');

                        if (!container || state.isFullScreen) return;

                        // Store original styles and DOM position
                        state.originalContainerStyle = container.getAttribute('style') || '';
                        state.originalParent = container.parentNode;
                        state.originalNextSibling = container.nextSibling;
                        state.originalBodyOverflow = document.body.style.overflow;
                        state.originalBodyPosition = document.body.style.position;
                        state.originalBodyWidth = document.body.style.width;
                        state.originalBodyHeight = document.body.style.height;
                        state.scrollPosition = window.pageYOffset || document.documentElement.scrollTop;

                        const backgroundColor = isDarkTheme ? '#36363e' : '#ffffff';

                        // Move container to body to escape parent constraints
                        document.body.appendChild(container);

                        // Apply fullscreen styles
                        container.classList.add('fullscreen-active');
                        container.style.backgroundColor = backgroundColor;
                        container.style.position = 'fixed';
                        container.style.top = '0';
                        container.style.left = '0';
                        container.style.width = '100vw';
                        container.style.height = '100vh';
                        container.style.zIndex = '9999';
                        container.style.margin = '0';
                        container.style.padding = '0';
                        container.style.border = 'none';
                        container.style.borderRadius = '0';
                        container.style.boxShadow = 'none';

                        // Lock body scroll
                        document.body.style.overflow = 'hidden';
                        document.body.style.position = 'fixed';
                        document.body.style.width = '100%';
                        document.body.style.height = '100%';
                        document.body.style.top = '0';
                        document.body.style.left = '0';
                        document.body.classList.add('fullscreen-mode');
                        document.documentElement.classList.add('fullscreen-active');

                        // Move JsonPathDisplay modal to body if it exists
                        const pathModal = document.querySelector('.path-modal-overlay');
                        if (pathModal && pathModal.parentNode !== document.body) {
                            if (!pathModal._originalParent) {
                                pathModal._originalParent = pathModal.parentNode;
                                pathModal._originalNextSibling = pathModal.nextSibling;
                            }
                            document.body.appendChild(pathModal);
                            console.log('✅ Moved existing JsonPathDisplay modal to body for fullscreen compatibility');
                        }

                        // Move JsonStatistics modal to body if it exists
                        const statsModal = document.querySelector('.stats-modal-overlay');
                        if (statsModal && statsModal.parentNode !== document.body) {
                            if (!statsModal._originalParent) {
                                statsModal._originalParent = statsModal.parentNode;
                                statsModal._originalNextSibling = statsModal.nextSibling;
                            }
                            document.body.appendChild(statsModal);
                            console.log('✅ Moved existing JsonStatistics modal to body for fullscreen compatibility');
                        }

                        state.isFullScreen = true;
                        console.log('✅ Entered FullScreen Mode');
                    };

                    window.exitJsonViewerFullScreen = function() {
                        const state = window.jsonViewerFullScreenState;
                        const container = document.querySelector('.json-viewer-container');

                        if (!container || !state.isFullScreen) return;

                        // Remove fullscreen class
                        container.classList.remove('fullscreen-active');

                        // Restore container styles
                        if (state.originalContainerStyle !== null && state.originalContainerStyle !== '') {
                            container.setAttribute('style', state.originalContainerStyle);
                        } else {
                            container.removeAttribute('style');
                        }

                        // Move container back to original position
                        if (state.originalParent) {
                            if (state.originalNextSibling) {
                                state.originalParent.insertBefore(container, state.originalNextSibling);
                            } else {
                                state.originalParent.appendChild(container);
                            }
                        }

                        // Restore body styles
                        if (state.originalBodyOverflow !== null) {
                            document.body.style.overflow = state.originalBodyOverflow;
                        } else {
                            document.body.style.overflow = '';
                        }
                        if (state.originalBodyPosition !== null) {
                            document.body.style.position = state.originalBodyPosition;
                        } else {
                            document.body.style.position = '';
                        }
                        if (state.originalBodyWidth !== null) {
                            document.body.style.width = state.originalBodyWidth;
                        } else {
                            document.body.style.width = '';
                        }
                        if (state.originalBodyHeight !== null) {
                            document.body.style.height = state.originalBodyHeight;
                        } else {
                            document.body.style.height = '';
                        }
                        document.body.style.top = '';
                        document.body.style.left = '';

                        document.body.classList.remove('fullscreen-mode');
                        document.documentElement.classList.remove('fullscreen-active');

                        // Restore JsonPathDisplay modal to original position if it was moved to body
                        const pathModal = document.querySelector('.path-modal-overlay');
                        if (pathModal && pathModal._originalParent) {
                            if (pathModal._originalNextSibling) {
                                pathModal._originalParent.insertBefore(pathModal, pathModal._originalNextSibling);
                            } else {
                                pathModal._originalParent.appendChild(pathModal);
                            }
                            pathModal._originalParent = null;
                            pathModal._originalNextSibling = null;
                            console.log('✅ Restored JsonPathDisplay modal to original position after exiting fullscreen');
                        }

                        // Restore JsonStatistics modal to original position if it was moved to body
                        const statsModal = document.querySelector('.stats-modal-overlay');
                        if (statsModal && statsModal._originalParent) {
                            if (statsModal._originalNextSibling) {
                                statsModal._originalParent.insertBefore(statsModal, statsModal._originalNextSibling);
                            } else {
                                statsModal._originalParent.appendChild(statsModal);
                            }
                            statsModal._originalParent = null;
                            statsModal._originalNextSibling = null;
                            console.log('✅ Restored JsonStatistics modal to original position after exiting fullscreen');
                        }

                        window.scrollTo(0, state.scrollPosition);

                        // Reset state
                        state.originalContainerStyle = null;
                        state.originalBodyOverflow = null;
                        state.originalBodyPosition = null;
                        state.originalBodyWidth = null;
                        state.originalBodyHeight = null;
                        state.originalParent = null;
                        state.originalNextSibling = null;
                        state.scrollPosition = 0;
                        state.isFullScreen = false;

                        console.log('✅ Exited FullScreen Mode');
                    };

                    document.addEventListener('keydown', function(e) {
                        if (e.key === 'F11') {
                            e.preventDefault();
                            const fullScreenBtn = document.querySelector('[title*=""Full Screen""], [title*=""Exit Full Screen""]');
                            if (fullScreenBtn) fullScreenBtn.click();
                        }

                        if (e.key === 'Escape' && window.jsonViewerFullScreenState.isFullScreen) {
                            const exitBtn = document.querySelector('[title*=""Exit Full Screen""]');
                            if (exitBtn) exitBtn.click();
                        }
                    });

                    window.jsonViewerFullScreenInitialized = true;
                    console.log('📦 JSON Viewer FullScreen Module Loaded');
                })();
            ");
        }
    }

    #endregion

    #region Full Screen Toggle Logic

    private async Task HandleToggleFullScreen()
    {
        try
        {
            var newState = !IsFullScreen;

            if (newState)
            {
                await JSRuntime.InvokeVoidAsync("enterJsonViewerFullScreen", IsDarkTheme);
            }
            else
            {
                await JSRuntime.InvokeVoidAsync("exitJsonViewerFullScreen");
            }

            await OnFullScreenChanged.InvokeAsync(newState);

            if (OnNotification.HasDelegate)
            {
                var message = newState ? "Entered Full Screen mode" : "Exited Full Screen mode";
                await OnNotification.InvokeAsync((message, "success"));
            }
        }
        catch (Exception ex)
        {
            if (OnNotification.HasDelegate)
            {
                await OnNotification.InvokeAsync(($"Error toggling Full Screen: {ex.Message}", "error"));
            }
            Console.WriteLine($"Error in HandleToggleFullScreen: {ex.Message}");
        }
    }

    #endregion
}


<style>

    .fullscreen-btn{
        width:100%;
    }

    .FullScreeen{
        width:100%;
    }

    .fullscreen-toggle-btn {
        display: inline-flex;
        align-items: center;
        gap: 6px;
        padding: 6px 12px;
        border: 1px solid #e0e0e0;
        border-radius: 6px;
        background: white;
        color: #1e1e1e;
        font-size: 13px;
        font-weight: 500;
        cursor: pointer;
        transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
        box-shadow: 0 1px 2px rgba(0, 0, 0, 0.05);
        position: relative;
        overflow: hidden;
    }

        .fullscreen-toggle-btn::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 0;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.3), transparent);
            transition: width 0.4s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .fullscreen-toggle-btn:hover::before {
            width: 100%;
        }

        .fullscreen-toggle-btn:hover {
            border-color: #0078d4;
            background: #f0f8ff;
            transform: translateY(-1px);
            box-shadow: 0 4px 8px rgba(0, 120, 212, 0.15);
        }

        .fullscreen-toggle-btn:active {
            transform: translateY(0);
            box-shadow: 0 1px 2px rgba(0, 120, 212, 0.2);
        }

        .fullscreen-toggle-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
        }

        .fullscreen-toggle-btn.dark-theme {
            background: #2d2d30;
            color: #d4d4d4;
            border-color: #3e3e42;
        }

            .fullscreen-toggle-btn.dark-theme::before {
                background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.1), transparent);
            }

            .fullscreen-toggle-btn.dark-theme:hover {
                background: #3e3e42;
                border-color: #0078d4;
                box-shadow: 0 4px 8px rgba(0, 120, 212, 0.2);
            }

    .icon-wrapper {
        display: flex;
        align-items: center;
        justify-content: center;
        transition: transform 0.2s cubic-bezier(0.4, 0, 0.2, 1);
    }

    .fullscreen-toggle-btn:hover .icon-wrapper {
        transform: scale(1.1);
    }

    .btn-text {
        font-size: 13px;
        font-weight: 500;
        letter-spacing: 0.3px;
    }

    /* Animation classes */
    .fullscreen-enter {
        animation: fullscreenEnter 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    }

    .fullscreen-exit {
        animation: fullscreenExit 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    }

    @@keyframes fullscreenEnter {
        from

    {
        opacity: 0;
        transform: scale(0.95);
    }

    to {
        opacity: 1;
        transform: scale(1);
    }

    }

    @@keyframes fullscreenExit {
        from

    {
        opacity: 1;
        transform: scale(1);
    }

    to {
        opacity: 0;
        transform: scale(0.95);
    }

    }
</style>
