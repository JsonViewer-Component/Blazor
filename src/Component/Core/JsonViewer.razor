@page "/json-viewer"
@using Component.Core.Features
@using Component.Models
@using Microsoft.JSInterop
@using System.Text
@using System.Text.RegularExpressions
@using System.Text.Json.Nodes
@using System.Text.Json
@inject IJSRuntime jsRuntime
@implements IDisposable

@* Global Loading Overlay *@
<LoadingOverlay IsVisible="@isLoading"
               IsDarkTheme="@isDarkTheme"
               Message="@loadingMessage" />

@* Statistics Modal *@
<JsonStatistics Statistics="@currentStats"
                IsVisible="@showStatistics"
                IsDarkTheme="@isDarkTheme"
                OnClose="@CloseStatistics" />

                    <div class="row">
        <div class="col-12">
            <div class="card shadow-sm">
                <div class="card-body p-0">
<div class="json-viewer-container @(isDarkTheme ? "dark-theme" : "light-theme") @(isFullScreen ? "full-screen fullscreen-active" : "")"
     @ref="containerRef" data-theme="@(isDarkTheme ? "dark" : "light")" style="direction:ltr;">

    @* Loading State Section *@
    @if (isProcessing)
    {
        <div class="loading-overlay">
            <div class="loading-spinner"></div>
            <div class="loading-text">Processing...</div>
        </div>
    }

    @* Main Center Section with Four-sided Layout *@
    <div class="json-viewer-main-layout">

        <div class="json-content-wrapper">
            @if (IsEditable && isEditMode)
            {
                @* Edit Mode *@
                <div class="edit-mode-container">

                    <div class="d-flex justify-content-between align-items-center mb-2">
                        <h5 class="mb-0">Edit JSON</h5>
                        <div class="d-flex gap-2">
                            <button class="btn btn-sm btn-success" @onclick="FormatAndView">
                                <i class="bi bi-check-circle"></i> Format & View
                            </button>
                            <button class="btn btn-sm btn-secondary" @onclick="ClearEditor">
                                <i class="bi bi-x-circle"></i> Clear
                            </button>
                        </div>
                    </div>

                    <textarea class="form-control json-editor"
                              @bind="editableJsonText"
                              @oninput="HandlePaste"
                              rows="20"
                              placeholder="Paste your JSON here..."></textarea>

                </div>
            }

            else if (jsonToken != null)
            {
                @* Layout with Left Sidebar Buttons *@
                <div class="json-viewer-with-sidebar">

                    @* Left Sidebar with Vertical Buttons *@
                    <div class="json-left-sidebar">
                        <button class="btn btn-sm btn-light mb-2 @(allExpanded ? "selected-btn-light-them" : "")"
                                @onclick="ExpandAll"
                                title="@(allExpanded ? "Collapse All" : "Expand All")">
                            <Icon Name="@(allExpanded ? "dash-square" : "plus-square")" Size="18" />
                        </button>

                        <button class="btn btn-sm btn-light" @onclick="ShowStatistics" title="View Statistics">
                            <Icon Name="bar-chart" Size="16" />
                        </button>

                        <button class="btn btn-sm btn-light mb-2"
                                @onclick="CopyToClipboard"
                                title="Copy JSON">
                            <Icon Name="clipboard" Size="18" />
                        </button>

                        <button class="btn btn-sm btn-light mb-2"
                                @onclick="DownloadJson"
                                title="Download JSON">
                            <Icon Name="download" Size="18" />
                        </button>

                        <div style="margin-top: auto;">
                                @* FullScreen Toggle - NEW! *@
                            <FullScreenToggle IsFullScreen="@isFullScreen"
                                 OnFullScreenChanged="@HandleFullScreenChanged"
                                 IsDarkTheme="@isDarkTheme" />

                            <ThemeToggle IsDark="@isDarkTheme"
                                         OnThemeChanged="@HandleThemeChanged" />
                        </div>

                    </div>

                    @* Wrapper for Top Toolbar + Main Content *@
                    <div class="json-content-column">
                        @* Top Toolbar (Edit Button) *@
                        @if (IsEditable && !isEditMode)
                        {
                            <div class="json-top-toolbar">

                                        @* Search & Navigation Section *@
                                <div class="search-navigation-container">

                                    <input type="text"
                                           class="form-control search-input"
                                           style="margin-left:10px;text-align:center;"
                                           placeholder="Search in JSON..."
                                           @bind="searchText"
                                           @bind:event="oninput"
                                           @onkeyup="OnSearchTextChanged"
                                           @onkeydown="HandleSearchKeyDown" />

                                        @if (!string.IsNullOrEmpty(searchText))
                                        {
                                            @* Search Input *@
                                            <div class="search-input-wrapper">
                                                <button class="btn btn-sm btn-light"
                                                        @onclick="ClearSearch"
                                                        title="Clear search">
                                                    <Icon Name="x-circle-fill" Size="14" />
                                                </button>
                                            </div>
                                        }

                                    @* Navigation Buttons *@
                                    <div class="search-navigation-buttons">
                                        @if (!string.IsNullOrEmpty(searchText) && matchCount > 0)
                                        {
                                            <button class="btn btn-sm btn-light scroll-nav-btn"
                                                    @onclick="NavigateToPreviousMatch"
                                                    disabled="@(matchCount == 0)"
                                                    title="Previous match (Shift+Enter)">
                                                <Icon Name="chevron-up" Size="16" />
                                            </button>

                                            <button class="btn btn-sm btn-light scroll-nav-btn"
                                                    @onclick="NavigateToNextMatch"
                                                    disabled="@(matchCount == 0)"
                                                    title="Next match (Enter)">
                                                <Icon Name="chevron-down" Size="16" />
                                            </button>
                                        }
                                    </div>

                                    @* Match Counter *@
                                    @if (!string.IsNullOrEmpty(searchText))
                                    {
                                        <div class="search-match-counter">
                                            @if (matchCount > 0)
                                            {
                                                <span class="match-info">@(currentMatchIndex + 1)/@matchCount</span>
                                            }
                                            else
                                            {
                                                <span class="no-match-info">No matches</span>
                                            }
                                        </div>
                                    }

                                </div>

                                <button class="btn btn-sm btn-light scroll-nav-btn"
                                        @onclick="BackToEdit"
                                        title="Edit JSON">
                                    <Icon Name="pencil" Size="14" />
                                </button>
                            </div>
                        }

                        @* JSON Content *@
                        <div class="json-main-content">
                            <div class="vscode-json-viewer">
                                @* Line Numbers Column *@
                                <div class="vscode-line-numbers">
                                    @for (int i = 1; i <= renderedLines.Count; i++)
                                    {
                                        <div class="vscode-line-number">@i</div>
                                    }
                                </div>

                                @* JSON Content Column *@
                                <div class="vscode-json-content">
                                    @for (int i = 0; i < renderedLines.Count; i++)
                                    {
                                        var line = renderedLines[i];
                                        var lineNumber = i + 1;
                                        var hasSearchMatch = searchMatches.Any(m => m.LineNumber == lineNumber);

                                        <div class="vscode-json-line @(hasSearchMatch ? "has-search-match" : "")">
                                            @* Indent Guides *@
                                            @for (int j = 0; j < line.IndentLevel; j++)
                                            {
                                                <span class="indent-guide" style="left: @((j * 20) + 10)px;"></span>
                                            }

                                            @* Line Content with Highlight *@
                                            <div class="vscode-line-content" style="margin-left: @(line.IndentLevel * 20)px;">
                                                @if (!string.IsNullOrWhiteSpace(searchText) && hasSearchMatch)
                                                {
                                                    @((MarkupString)HighlightSearchInLine(line.Content, lineNumber))
                                                }
                                                else
                                                {
                                                    @((MarkupString)line.Content)
                                                }
                                            </div>
                                        </div>
                                    }
                                </div>


                            </div>
                        </div>
                    </div>

                    @* Right Sidebar with Vertical Buttons *@
                    <div class="json-viewer-right-section">
                        @if (jsonToken != null && !isEditMode)
                        {
                            @* Scroll Navigation Buttons *@
                            <div class="scroll-navigation-buttons">
                                <button class="btn btn-sm btn-light scroll-nav-btn"
                                        @onclick="ScrollToTop"
                                        title="Scroll to Top">
                                    <Icon Name="arrow-up" Size="16" />
                                </button>
                                <button class="btn btn-sm btn-light scroll-nav-btn"
                                        @onclick="ScrollToBottom"
                                        title="Scroll to Bottom">
                                    <Icon Name="arrow-down" Size="16" />
                                </button>
                            </div>
                        }
                    </div>

                </div>
            }

            else
            {
                <div class="alert alert-info">
                    <i class="bi bi-info-circle"></i>
                    @(IsEditable ? "Click 'Edit' to add JSON data" : "No JSON data to display")
                </div>
            }
        </div>

    </div>

    @* Bottom Section - For Future Features *@
    <div class="json-viewer-bottom-section">

@* Bottom Section *@
<div class="json-viewer-bottom-section">

</div>



    </div>

</div>

</div>
</div>
</div>
</div>
@code {
    #region Parameters

    [Parameter] public string JsonData { get; set; }
    [Parameter] public EventCallback<string> JsonDataChanged { get; set; }
    [Parameter] public bool IsEditable { get; set; } = false;

    // Statistics
    private bool showStatistics = false;
    private JsonStats? currentStats = null;

    #endregion

    #region Loading State
    private bool isLoading = false;
    private string loadingMessage = "Processing...";
    #endregion

    #region State Variables
    private JsonNode? jsonToken;
    private Dictionary<string, bool> expandedStates = new();
    private bool allExpanded = true;
    private bool isDarkTheme = true;
    private bool isFullScreen = false;
    private bool isEditMode = true;
    private string editableJsonText = "";
    private bool isProcessing = false;
    private ElementReference containerRef;

    // VS Code Style Rendering
    private List<JsonLine> renderedLines = new();

    // Dispose Resources
    private CancellationTokenSource pasteCancellationTokenSource;
    private System.Threading.Timer autoFormatTimer;
    private DotNetObjectReference<JsonViewer> dotNetHelper;
    #endregion

    #region Search & Navigation Variables
    private string searchText = string.Empty;
    private List<SearchMatch> searchMatches = new List<SearchMatch>();
    private int currentMatchIndex = -1;
    private int matchCount = 0;
    private bool isNavigating = false;
    #endregion

    #region Lifecycle
    protected override void OnParametersSet()
    {
        if (IsEditable)
        {
            if (!string.IsNullOrWhiteSpace(JsonData))
            {
                isEditMode = false;
                try
                {
                    jsonToken = JsonNode.Parse(JsonData);
                    editableJsonText = jsonToken?.ToJsonString(new JsonSerializerOptions
                    {
                        WriteIndented = true
                    }) ?? string.Empty;
                    RenderJsonLines();
                }
                catch
                {
                    jsonToken = null;
                    editableJsonText = JsonData;
                    isEditMode = true;
                }
            }
            else
            {
                isEditMode = true;
                jsonToken = null;
                editableJsonText = string.Empty;
            }
        }
        else
        {
            isEditMode = false;
            if (!string.IsNullOrWhiteSpace(JsonData))
            {
                try
                {
                    jsonToken = JsonNode.Parse(JsonData);
                    RenderJsonLines();
                }
                catch
                {
                    jsonToken = null;
                }
            }
            else
            {
                jsonToken = null;
            }
        }

        if (jsonToken != null && !expandedStates.Any())
        {
            allExpanded = true;
        }
    }

    protected override async Task OnAfterRenderAsync(bool firstRender)
{
    if (firstRender)
    {
        try
        {
            dotNetHelper = DotNetObjectReference.Create(this);

            // Register all JS Functions
            await jsRuntime.InvokeVoidAsync("eval", @"
                // Theme Auto-Sync System (fully independent)
                if (!window.jsonViewerThemeSyncInitialized) {

                    // Function to detect all Theme Keys
                    window.detectParentTheme = function() {
                        const themeKeys = ['app-theme', 'main-theme', 'theme', 'appTheme', 'mainTheme'];

                        for (let key of themeKeys) {
                            const value = localStorage.getItem(key);
                            if (value === 'dark' || value === 'Dark' ||
                                value === 'light' || value === 'Light') {
                                return value.toLowerCase();
                            }
                        }
                        return null;
                    };

                    // Function to apply theme to component
                    window.applyJsonViewerTheme = function(theme) {
                        const container = document.querySelector('.json-viewer-container');
                        if (container) {
                            if (theme === 'dark') {
                                container.classList.add('dark-theme');
                                container.classList.remove('light-theme');
                                container.setAttribute('data-theme', 'dark');
                            } else {
                                container.classList.remove('dark-theme');
                                container.classList.add('light-theme');
                                container.setAttribute('data-theme', 'light');
                            }
                        }
                    };

                    // ðŸ“Š Storage Event Listener (Cross-Tab Sync)
                    window.addEventListener('storage', function(e) {
                        // Check all Theme Keys
                        if (e.key && e.key.toLowerCase().includes('theme') && e.newValue) {
                            const normalizedTheme = e.newValue.toLowerCase();

                            if (normalizedTheme === 'dark' || normalizedTheme === 'light') {
                                // Save in component's own session
                                localStorage.setItem('json-viewer-theme', normalizedTheme);

                                // Apply to UI
                                window.applyJsonViewerTheme(normalizedTheme);

                                console.log('âœ… JsonViewer synced theme from:', e.key, 'â†’', normalizedTheme);
                            }
                        }
                    });

                    // Polling for Same-Tab Updates (every 500ms)
                    window.jsonViewerThemePoller = setInterval(function() {
                        const currentJsonViewerTheme = localStorage.getItem('json-viewer-theme');
                        const parentTheme = window.detectParentTheme();

                        if (parentTheme && parentTheme !== currentJsonViewerTheme) {
                            localStorage.setItem('json-viewer-theme', parentTheme);
                            window.applyJsonViewerTheme(parentTheme);
                            console.log('ðŸ”„ JsonViewer auto-synced theme:', parentTheme);
                        }
                    }, 500);

                    window.jsonViewerThemeSyncInitialized = true;
                }

                // âœ… Scroll Sync
                if (!window.jsonViewerScrollSynced) {
                    const syncScroll = () => {
                        const viewers = document.querySelectorAll('.vscode-json-viewer');
                        viewers.forEach(viewer => {
                            const content = viewer.querySelector('.vscode-json-content');
                            const lineNumbers = viewer.querySelector('.vscode-line-numbers');

                            if (content && lineNumbers) {
                                content.addEventListener('scroll', () => {
                                    lineNumbers.scrollTop = content.scrollTop;
                                });
                            }
                        });
                    };

                    syncScroll();
                    const observer = new MutationObserver(syncScroll);
                    observer.observe(document.body, { childList: true, subtree: true });

                    window.jsonViewerScrollSynced = true;
                }

                // âœ… Scroll Navigation Functions
                window.scrollJsonContentToTop = function() {
                    const content = document.querySelector('.vscode-json-content');
                    if (content) {
                        content.scrollTo({
                            top: 0,
                            behavior: 'smooth'
                        });
                    }
                };

                window.scrollJsonContentToBottom = function() {
                    const content = document.querySelector('.vscode-json-content');
                    if (content) {
                        content.scrollTo({
                            top: content.scrollHeight,
                            behavior: 'smooth'
                        });
                    }
                };

                // âœ… Toggle Handler
                if (!window.jsonViewerInitialized) {
                    window.jsonViewerDotNetHelper = null;

                    window.registerJsonViewerToggle = function(dotNetHelper) {
                        window.jsonViewerDotNetHelper = dotNetHelper;
                    };

                    document.addEventListener('click', function(e) {
                        if (e.target.classList.contains('json-toggle')) {
                            const tokenId = e.target.getAttribute('data-token-id');
                            if (tokenId && window.jsonViewerDotNetHelper) {
                                window.jsonViewerDotNetHelper.invokeMethodAsync('ToggleExpandFromJS', tokenId);
                            }
                        }
                    });
                }

                // âœ… Active Line Click Handler
                if (!window.jsonViewerActiveLineInitialized) {
                    document.addEventListener('click', function(e) {
                        const jsonLine = e.target.closest('.vscode-json-line');

                        if (jsonLine) {
                            document.querySelectorAll('.vscode-json-line.active-line').forEach(line => {
                                line.classList.remove('active-line');
                            });
                            document.querySelectorAll('.vscode-line-number.active-line-number').forEach(num => {
                                num.classList.remove('active-line-number');
                            });

                            jsonLine.classList.add('active-line');

                            const allLines = Array.from(jsonLine.parentElement.querySelectorAll('.vscode-json-line'));
                            const lineIndex = allLines.indexOf(jsonLine);

                            if (lineIndex >= 0) {
                                const viewer = jsonLine.closest('.vscode-json-viewer');
                                if (viewer) {
                                    const lineNumbers = viewer.querySelectorAll('.vscode-line-number');
                                    if (lineNumbers[lineIndex]) {
                                        lineNumbers[lineIndex].classList.add('active-line-number');
                                    }
                                }
                            }
                        }
                    });

                    window.jsonViewerActiveLineInitialized = true;
                }

                window.jsonViewerInitialized = true;
            ");

            await jsRuntime.InvokeVoidAsync("registerJsonViewerToggle", dotNetHelper);

            // Load Initial Theme with Priority
            var jsonViewerTheme = await jsRuntime.InvokeAsync<string>("localStorage.getItem", "json-viewer-theme");

            // If it doesn't have its own session, get from Parent
            if (string.IsNullOrEmpty(jsonViewerTheme))
            {
                jsonViewerTheme = await jsRuntime.InvokeAsync<string>("detectParentTheme");

                if (!string.IsNullOrEmpty(jsonViewerTheme))
                {
                    await jsRuntime.InvokeVoidAsync("localStorage.setItem", "json-viewer-theme", jsonViewerTheme);
                }
            }

            if (!string.IsNullOrEmpty(jsonViewerTheme))
            {
                isDarkTheme = jsonViewerTheme == "dark";
                await jsRuntime.InvokeVoidAsync("applyJsonViewerTheme", jsonViewerTheme);
                StateHasChanged();
            }
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error in OnAfterRenderAsync: {ex.Message}");
        }
    }
}


    // Method called from JS for auto sync
    [JSInvokable]
    public async Task OnThemeChangedFromStorage(bool isDark)
        {
            isDarkTheme = isDark;
            StateHasChanged();

            Console.WriteLine($"ðŸŽ¨ Theme synced from storage: {(isDark ? "Dark" : "Light")}");
        }


    #endregion

    #region VS Code Style Rendering

    private void RenderJsonLines()
    {
        renderedLines.Clear();
        if (jsonToken == null) return;

        RenderTokenToLines(jsonToken, 0);
    }

    private void RenderTokenToLines(JsonNode token, int indentLevel)
    {
        switch (token)
        {
            case JsonObject obj:
                RenderObjectToLines(obj, indentLevel);
                break;
            case JsonArray	 arr:
                RenderArrayToLines(arr, indentLevel);
                break;
            default:
                RenderValueToLines(token, indentLevel);
                break;
        }
    }

    private void RenderObjectToLines(JsonObject obj, int indentLevel)
{
    string id = obj.GetHashCode().ToString();
    bool isExpanded = expandedStates.GetValueOrDefault(id, allExpanded);

    // Opening line {
    renderedLines.Add(new JsonLine
    {
        IndentLevel = indentLevel,
        Content = $"<span class='json-toggle' data-token-id='{id}'>{(isExpanded ? "â–¼" : "â–¶")}</span><span class='json-punctuation'>{{</span>",
        Token = obj
    });

    if (isExpanded)
    {
        var properties = obj.ToList(); // Convert to list
        for (int i = 0; i < properties.Count; i++)
        {
            var prop = properties[i];
            var comma = i < properties.Count - 1 ? "," : "";

            // Property line
            var propLine = new JsonLine
            {
                IndentLevel = indentLevel + 1,
                Token = prop.Value
            };

            // Build Property content
            var sb = new StringBuilder();
            sb.Append($"<span class='json-property-name'>\"{prop.Key}\"</span>"); // Use .Key
            sb.Append("<span class='json-punctuation'>: </span>");

            // Property value
            if (prop.Value is JsonObject || prop.Value is JsonArray)
            {
                propLine.Content = sb.ToString();
                renderedLines.Add(propLine);
                RenderTokenToLines(prop.Value, indentLevel + 1);
            }
            else
            {
                sb.Append(GetValueHtml(prop.Value));
                sb.Append($"<span class='json-punctuation'>{comma}</span>");
                propLine.Content = sb.ToString();
                renderedLines.Add(propLine);
            }
        }
    }
    else
    {
        // Collapsed state
        renderedLines.Add(new JsonLine
        {
            IndentLevel = indentLevel + 1,
            Content = $"<span class='json-collapsed'>... {obj.Count} properties</span>", // Use .Count
            Token = obj
        });
    }

    // Closing line }
    renderedLines.Add(new JsonLine
    {
        IndentLevel = indentLevel,
        Content = "<span class='json-punctuation'>}</span>",
        Token = obj
    });
}


    private void RenderArrayToLines(JsonArray	 arr, int indentLevel)
    {
        string id = arr.GetHashCode().ToString();
        bool isExpanded = expandedStates.GetValueOrDefault(id, allExpanded);

        // Opening line [
        renderedLines.Add(new JsonLine
        {
            IndentLevel = indentLevel,
            Content = $"<span class='json-toggle' data-token-id='{id}'>{(isExpanded ? "â–¼" : "â–¶")}</span><span class='json-punctuation'>[</span>",
            Token = arr
        });

        if (isExpanded)
        {
            for (int i = 0; i < arr.Count; i++)
            {
                var item = arr[i];
                var comma = i < arr.Count - 1 ? "," : "";

                if (item is JsonObject || item is JsonArray	)
                {
                    RenderTokenToLines(item, indentLevel + 1);
                }
                else
                {
                    renderedLines.Add(new JsonLine
                    {
                        IndentLevel = indentLevel + 1,
                        Content = $"{GetValueHtml(item)}<span class='json-punctuation'>{comma}</span>",
                        Token = item
                    });
                }
            }
        }
        else
        {
            renderedLines.Add(new JsonLine
            {
                IndentLevel = indentLevel + 1,
                Content = $"<span class='json-collapsed'>... {arr.Count} items</span>",
                Token = arr
            });
        }

        // Closing line ]
        renderedLines.Add(new JsonLine
        {
            IndentLevel = indentLevel,
            Content = "<span class='json-punctuation'>]</span>",
            Token = arr
        });
    }

    private void RenderValueToLines(JsonNode token, int indentLevel)
    {
        renderedLines.Add(new JsonLine
        {
            IndentLevel = indentLevel,
            Content = GetValueHtml(token),
            Token = token
        });
    }

    private string GetValueHtml(JsonNode? node)
    {
        if (node == null)
            return "<span class='json-null'>null</span>";

        // Use JsonValue to access the actual type
        if (node is JsonValue jsonValue)
        {
            // Check value type
            if (jsonValue.TryGetValue<string>(out var strValue))
                return $"<span class='json-string'>\"{strValue}\"</span>";

            if (jsonValue.TryGetValue<bool>(out var boolValue))
                return $"<span class='json-boolean'>{boolValue.ToString().ToLower()}</span>";

            if (jsonValue.TryGetValue<int>(out _) ||
                jsonValue.TryGetValue<long>(out _) ||
                jsonValue.TryGetValue<decimal>(out _))
                return $"<span class='json-number'>{node.ToJsonString()}</span>";

            if (jsonValue.TryGetValue<double>(out _) ||
                jsonValue.TryGetValue<float>(out _))
                return $"<span class='json-number'>{node.ToJsonString()}</span>";
        }

        return $"<span class='json-value'>{node.ToJsonString()}</span>";
    }


    #endregion

    #region Toggle Methods

    [JSInvokable]
    public void ToggleExpandFromJS(string tokenId)
    {
        if (expandedStates.ContainsKey(tokenId))
        {
            expandedStates[tokenId] = !expandedStates[tokenId];
        }
        else
        {
            expandedStates[tokenId] = !allExpanded; // Opposite of allExpanded
        }

        RenderJsonLines();
        StateHasChanged();
    }

    private void ExpandAll()
    {
        if (allExpanded)
        {
            // If all are expanded, collapse all
            CollapseAll();
        }
        else
        {
            // If all are collapsed, expand all
            expandedStates.Clear();
            allExpanded = true;
            RenderJsonLines();
        }
    }


    private void CollapseAll()
    {
        allExpanded = false;
        PopulateExpandedStates(jsonToken, false);
        RenderJsonLines();
        StateHasChanged();
    }

    private void PopulateExpandedStates(JsonNode token, bool state)
    {
        if (token == null) return;

        if (token is JsonObject obj)
        {
            string id = obj.GetHashCode().ToString();
            expandedStates[id] = state;

            foreach (var kvp in obj)
            {
                PopulateExpandedStates(kvp.Value, state);
            }
        }
        else if (token is JsonArray	 arr)
        {
            string id = arr.GetHashCode().ToString();
            expandedStates[id] = state;

            foreach (var item in arr)
            {
                PopulateExpandedStates(item, state);
            }
        }
    }

    /// <summary>
    /// Handle theme change from ThemeToggle
    /// </summary>
private async Task HandleThemeChanged(bool isDark)
{
    isDarkTheme = isDark;
    var themeValue = isDark ? "dark" : "light";

    try
    {
        // Update all Session Keys containing 'theme'
        await jsRuntime.InvokeVoidAsync("eval", $@"
            (function() {{
                const themeKeys = [];
                for (let i = 0; i < localStorage.length; i++) {{
                    const key = localStorage.key(i);
                    if (key && (key.toLowerCase().includes('theme'))) {{
                        themeKeys.push(key);
                    }}
                }}

                themeKeys.forEach(key => {{
                    localStorage.setItem(key, '{themeValue}');
                }});

                if (!themeKeys.includes('json-viewer-theme')) {{
                    localStorage.setItem('json-viewer-theme', '{themeValue}');
                }}
            }})()
        ");
    }
    catch (Exception ex)
    {
        Console.WriteLine($"Error syncing theme: {ex.Message}");
    }

    // Apply theme to UI
    var action = isDark ? "add" : "remove";
    await jsRuntime.InvokeVoidAsync("eval",
        $"document.querySelector('.json-viewer-container')?.classList.{action}('dark-theme')");

    StateHasChanged();
}


    #endregion

    #region Scroll Navigation

    private async Task ScrollToTop()
    {
        try
        {
            await jsRuntime.InvokeVoidAsync("scrollJsonContentToTop");
        }
        catch (Exception ex)
        {
            Console.WriteLine($"ScrollToTop error: {ex.Message}");
        }
    }

    private async Task ScrollToBottom()
    {
        try
        {
            await jsRuntime.InvokeVoidAsync("scrollJsonContentToBottom");
        }
        catch (Exception ex)
        {
            Console.WriteLine($"ScrollToBottom error: {ex.Message}");
        }
    }

    #endregion

    #region Editable Mode

private async Task FormatAndView()
{
    if (string.IsNullOrWhiteSpace(editableJsonText))
    {
        await jsRuntime.InvokeVoidAsync("alert", "Please enter JSON data first");
        return;
    }

    // Enable Loading
    isLoading = true;
    loadingMessage = "Formatting and rendering JSON...";
    StateHasChanged();

    try
    {
        await Task.Delay(100);

        // Parse JSON
        jsonToken = JsonNode.Parse(editableJsonText);

        // Beautify with proper formatting
        var options = new JsonSerializerOptions { WriteIndented = true };
        JsonData = jsonToken!.ToJsonString(options);

        if (JsonDataChanged.HasDelegate)
        {
            await JsonDataChanged.InvokeAsync(JsonData);
        }

        expandedStates.Clear();
        allExpanded = true;

        RenderJsonLines();

        isEditMode = false;

        await Task.Delay(50);
        StateHasChanged();
    }
    catch (JsonException ex)  // System.Text.Json exception
    {
        await jsRuntime.InvokeVoidAsync("alert", $"Invalid JSON: {ex.Message}");
    }
    catch (Exception ex)
    {
        await jsRuntime.InvokeVoidAsync("alert", $"Error: {ex.Message}");
    }
    finally
    {
        // Disable Loading
        isLoading = false;
        StateHasChanged();
    }
}

private void BackToEdit()
{
    isEditMode = true;
    if (jsonToken != null)
    {
        // Use ToJsonString instead of ToString
        var options = new JsonSerializerOptions { WriteIndented = true };
        editableJsonText = jsonToken.ToJsonString(options);
    }
    else
    {
        editableJsonText = JsonData ?? "";
    }
    StateHasChanged();
}


    private void ClearEditor()
    {
        editableJsonText = "";
        StateHasChanged();
    }

    private void HandlePaste(ChangeEventArgs e)
    {
        editableJsonText = e.Value?.ToString() ?? "";
    }

    #endregion

    #region Utility Methods

private async Task CopyToClipboard()
{
    if (jsonToken != null)
    {
        var json = FormatJsonNode(jsonToken);
        await jsRuntime.InvokeVoidAsync("navigator.clipboard.writeText", json);
    }
}

private async Task DownloadJson()
{
    if (jsonToken != null)
    {
        var json = FormatJsonNode(jsonToken);
        var fileName = $"export_{DateTime.Now:yyyyMMdd_HHmmss}.json";

        // Serialize with System.Text.Json
        var jsonForJs = JsonSerializer.Serialize(json);

        await jsRuntime.InvokeVoidAsync("eval", $@"
            const json = {jsonForJs};
            const blob = new Blob([json], {{ type: 'application/json' }});
            const url = URL.createObjectURL(blob);
            const link = document.createElement('a');
            link.href = url;
            link.download = '{fileName}';
            link.click();
            URL.revokeObjectURL(url);
        ");
    }
}



    #endregion

    #region Helper Methods

/// <summary>
/// Format JsonNode to JSON String
/// </summary>
private string FormatJsonNode(JsonNode? node)
{
    if (node == null) return string.Empty;

    var options = new JsonSerializerOptions
    {
        WriteIndented = true,
        Encoder = System.Text.Encodings.Web.JavaScriptEncoder.UnsafeRelaxedJsonEscaping
    };

    return node.ToJsonString(options);
}

#endregion

    #region Dispose

    public void Dispose()
    {
        dotNetHelper?.Dispose();

        // Clear Polling Timer
        jsRuntime.InvokeVoidAsync("eval", @"
            if (window.jsonViewerThemePoller) {
                clearInterval(window.jsonViewerThemePoller);
            }
        ");
    }

    #endregion

    #region Helper Classes

    private class JsonLine
    {
        public int IndentLevel { get; set; }
        public string Content { get; set; }
        public JsonNode Token { get; set; }
        public string PlainText { get; set; } = string.Empty;
        public bool IsExpandable { get; set; }
        public bool IsExpanded { get; set; } = true;
        public string? ToggleId { get; set; }
    }

    #endregion

    #region Search & Navigation Methods

    /// <summary>
    /// Handle search text change
    /// </summary>
    private async Task OnSearchTextChanged()
    {
        if (string.IsNullOrWhiteSpace(searchText))
        {
            ClearSearch();
            return;
        }

        await PerformSearch();
    }

    /// <summary>
/// Search text in JSON
/// </summary>
private async Task PerformSearch()
{
    searchMatches.Clear();
    currentMatchIndex = -1;
    matchCount = 0;

    if (string.IsNullOrWhiteSpace(searchText) || renderedLines == null || !renderedLines.Any())
    {
        StateHasChanged();
        return;
    }

    // Step 1: Expand All before search (so all lines are rendered)
    if (!allExpanded)
    {
        expandedStates.Clear();
        allExpanded = true;
        RenderJsonLines(); // Re-render with all lines expanded
    }

    var searchLower = searchText.ToLower();

    // Step 2: Search only in Plain Text
    for (int i = 0; i < renderedLines.Count; i++)
    {
        var line = renderedLines[i];

        // Extract Plain Text from HTML
        var plainText = ExtractPlainTextFromHtml(line.Content);
        var plainTextLower = plainText.ToLower();

        int startIndex = 0;
        while ((startIndex = plainTextLower.IndexOf(searchLower, startIndex)) != -1)
        {
            searchMatches.Add(new SearchMatch
            {
                LineNumber = i + 1,
                StartIndex = startIndex,
                Length = searchText.Length,
                MatchedText = searchText,
                LineContent = line.Content, // HTML Content
                PlainText = plainText // Plain Text
            });

            startIndex += searchText.Length;
        }
    }

    matchCount = searchMatches.Count;

    if (matchCount > 0)
    {
        currentMatchIndex = 0;
        await ScrollToCurrentMatch();
    }

    StateHasChanged();
}


    private async Task HandleSearchKeyDown(KeyboardEventArgs e)
    {
        if (matchCount == 0) return;

        if (e.Key == "Enter")
        {
            if (e.ShiftKey)
            {
                await NavigateToPreviousMatch();
            }
            else
            {
                await NavigateToNextMatch();
            }
        }
    }

    /// <summary>
    /// Navigate to next match
    /// </summary>
    private async Task NavigateToNextMatch()
    {
        if (matchCount == 0) return;

        currentMatchIndex = (currentMatchIndex + 1) % matchCount;
        isNavigating = true;
        await ScrollToCurrentMatch();
        StateHasChanged();
    }

    /// <summary>
    /// Navigate to previous match
    /// </summary>
    private async Task NavigateToPreviousMatch()
    {
        if (matchCount == 0) return;

        currentMatchIndex = (currentMatchIndex - 1 + matchCount) % matchCount;
        isNavigating = true;
        await ScrollToCurrentMatch();
        StateHasChanged();
    }

    /// <summary>
    /// Scroll to current match (sync Line Numbers + JSON Content)
    /// </summary>
    private async Task ScrollToCurrentMatch()
    {
        if (currentMatchIndex < 0 || currentMatchIndex >= searchMatches.Count)
            return;

        var match = searchMatches[currentMatchIndex];

        try
        {
            await jsRuntime.InvokeVoidAsync("eval", $@"
            (function() {{
                // Find the target Line Number
                const lineNumbers = document.querySelectorAll('.vscode-line-number');
                const jsonLines = document.querySelectorAll('.vscode-json-line');

                if (!lineNumbers[{match.LineNumber - 1}] || !jsonLines[{match.LineNumber - 1}]) {{
                    console.error('Line not found!');
                    return;
                }}

                const targetLineNumber = lineNumbers[{match.LineNumber - 1}];
                const targetJsonLine = jsonLines[{match.LineNumber - 1}];

                // Find Scroll Containers
                const lineNumbersContainer = document.querySelector('.vscode-line-numbers');
                const jsonContentContainer = document.querySelector('.vscode-json-content');

                if (!lineNumbersContainer || !jsonContentContainer) {{
                    console.error('Containers not found!');
                    return;
                }}

                // Calculate position
                const lineOffset = targetLineNumber.offsetTop;
                const containerHeight = jsonContentContainer.clientHeight;
                const scrollPosition = lineOffset - (containerHeight / 2) + 10;

                // Simultaneous Smooth Scroll
                lineNumbersContainer.scrollTo({{
                    top: scrollPosition,
                    behavior: 'smooth'
                }});

                jsonContentContainer.scrollTo({{
                    top: scrollPosition,
                    behavior: 'smooth'
                }});

                // Pulse Effect on Line Number
                targetLineNumber.classList.add('search-highlight-pulse');
                setTimeout(() => {{
                    targetLineNumber.classList.remove('search-highlight-pulse');
                }}, 1000);

                // Pulse Effect on JSON Line
                targetJsonLine.classList.add('search-highlight-pulse');
                setTimeout(() => {{
                    targetJsonLine.classList.remove('search-highlight-pulse');
                }}, 1000);
            }})();
        ");
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Scroll to match error: {{ex.Message}}");
        }
    }

    /// <summary>
    /// Clear search
    /// </summary>
    private void ClearSearch()
    {
        searchText = string.Empty;
        searchMatches.Clear();
        currentMatchIndex = -1;
        matchCount = 0;
        StateHasChanged();
    }

    /// <summary>
    /// Extract Plain Text from HTML content
    /// </summary>
    private string ExtractPlainTextFromHtml(string htmlContent)
    {
        if (string.IsNullOrWhiteSpace(htmlContent))
            return string.Empty;

        // Remove all HTML tags
        var plainText = System.Text.RegularExpressions.Regex.Replace(htmlContent, @"<[^>]+>", string.Empty);

        // Decode HTML Entities
        plainText = System.Net.WebUtility.HtmlDecode(plainText);

        return plainText;
    }

    #endregion

    #region Search Highlighting in Content

    /// <summary>
    /// Highlight search results in a line
    /// </summary>
    private string HighlightSearchInLine(string content, int lineNumber)
    {
        if (string.IsNullOrWhiteSpace(searchText) || searchMatches == null || !searchMatches.Any())
            return content;

        var matchesInLine = searchMatches
            .Where(m => m.LineNumber == lineNumber)
            .OrderBy(m => m.StartIndex)
            .ToList();

        if (!matchesInLine.Any())
            return content;

        // Extract Plain Text
        var plainText = ExtractPlainTextFromHtml(content);

        var result = new StringBuilder();
        var lastIndex = 0;

        foreach (var match in matchesInLine)
        {
            // Text before Match
            if (match.StartIndex > lastIndex)
            {
                result.Append(System.Net.WebUtility.HtmlEncode(plainText.Substring(lastIndex, match.StartIndex - lastIndex)));
            }

            // The Match itself
            var matchText = plainText.Substring(match.StartIndex, match.Length);
            var matchIndex = searchMatches.IndexOf(match);
            var isCurrent = matchIndex == currentMatchIndex;

            var highlightClass = isCurrent ? "search-highlight-current" : "search-highlight";
            result.Append($"<span class=\"{highlightClass}\">{System.Net.WebUtility.HtmlEncode(matchText)}</span>");

            lastIndex = match.StartIndex + match.Length;
        }

        // Remaining text
        if (lastIndex < plainText.Length)
        {
            result.Append(System.Net.WebUtility.HtmlEncode(plainText.Substring(lastIndex)));
        }

        return result.ToString();
    }


    #endregion

    #region Helper Classes
    private class SearchMatch
    {
        public int LineNumber { get; set; }
        public int StartIndex { get; set; }
        public int Length { get; set; }
        public string MatchedText { get; set; } = string.Empty;
        public string LineContent { get; set; } = string.Empty;
        public string PlainText { get; set; } = string.Empty; // Added
    }
    #endregion

    #region Fullscreen mode

    /// <summary>
/// Handle FullScreen state change
/// </summary>
private async Task HandleFullScreenChanged(bool isFullScreenValue)
{
    isFullScreen = isFullScreenValue;
    StateHasChanged();

    // Sync Scroll after FullScreen animation
    if (!string.IsNullOrEmpty(JsonData))
    {
        await Task.Delay(350); // Wait for animation to complete
        try
        {
            await jsRuntime.InvokeVoidAsync("updateScrollSync");
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error updating scroll after fullscreen: {ex.Message}");
        }
    }
}


    #endregion

    #region Statistics Methods

/// <summary>
/// Calculate complete JSON statistics
/// </summary>
private JsonStats CalculateStatistics()
{
    if (jsonToken == null)
        return new JsonStats();

    var stats = new JsonStats();
    var rawJson = JsonData ?? string.Empty;
    var formattedJson = FormatJsonNode(jsonToken);

    stats.RawSize = Encoding.UTF8.GetByteCount(rawJson);
    stats.FormattedSize = Encoding.UTF8.GetByteCount(formattedJson);
    stats.MaxDepth = CalculateMaxDepth(jsonToken);

    // Count data types
    CountTokenTypes(jsonToken, stats, 0);

    // Calculate averages
    if (stats.ObjectCount > 0)
    {
        stats.AvgPropertiesPerObject = (double)stats.TotalProperties / stats.ObjectCount;
    }

    if (stats.ArrayCount > 0)
    {
        stats.AvgArrayLength = CalculateAverageArrayLength(jsonToken);
    }

    return stats;
}

/// <summary>
/// Count Token types recursively
/// </summary>
private void CountTokenTypes(JsonNode? token, JsonStats stats, int depth)
{
    if (token == null)
    {
        stats.NullCount++;
        return;
    }

    switch (token)
    {
        case JsonObject obj:
            stats.ObjectCount++;
            stats.TotalProperties += obj.Count;

            foreach (var kvp in obj)
            {
                CountTokenTypes(kvp.Value, stats, depth + 1);
            }
            break;

        case JsonArray arr:
            stats.ArrayCount++;
            foreach (var item in arr)
            {
                CountTokenTypes(item, stats, depth + 1);
            }
            break;

        case JsonValue val:
            var element = val.GetValue<JsonElement>();

            switch (element.ValueKind)
            {
                case JsonValueKind.String:
                    stats.StringCount++;
                    break;

                case JsonValueKind.Number:
                    stats.NumberCount++;
                    break;

                case JsonValueKind.True:
                case JsonValueKind.False:
                    stats.BooleanCount++;
                    break;

                case JsonValueKind.Null:
                    stats.NullCount++;
                    break;
            }
            break;
    }
}

/// <summary>
/// Calculate maximum JSON depth
/// </summary>
private int CalculateMaxDepth(JsonNode? token, int currentDepth = 0)
{
    if (token == null) return currentDepth;

    int maxDepth = currentDepth;

    switch (token)
    {
        case JsonObject obj:
            foreach (var kvp in obj)
            {
                int childDepth = CalculateMaxDepth(kvp.Value, currentDepth + 1);
                maxDepth = Math.Max(maxDepth, childDepth);
            }
            break;

        case JsonArray arr:
            foreach (var item in arr)
            {
                int childDepth = CalculateMaxDepth(item, currentDepth + 1);
                maxDepth = Math.Max(maxDepth, childDepth);
            }
            break;
    }

    return maxDepth;
}

/// <summary>
/// Calculate average array length
/// </summary>
private double CalculateAverageArrayLength(JsonNode? token)
{
    var arrays = new List<int>();
    CollectArrayLengths(token, arrays);
    return arrays.Any() ? arrays.Average() : 0;
}

/// <summary>
/// Collect lengths of all arrays
/// </summary>
private void CollectArrayLengths(JsonNode? token, List<int> lengths)
{
    if (token == null) return;

    switch (token)
    {
        case JsonArray arr:
            lengths.Add(arr.Count);
            foreach (var item in arr)
            {
                CollectArrayLengths(item, lengths);
            }
            break;

        case JsonObject obj:
            foreach (var kvp in obj)
            {
                CollectArrayLengths(kvp.Value, lengths);
            }
            break;
    }
}

/// <summary>
/// Toggle Statistics display
/// </summary>
private void ToggleStatistics()
{
    showStatistics = !showStatistics;

    if (showStatistics && jsonToken != null)
    {
        currentStats = CalculateStatistics();
    }

    StateHasChanged();
}

#endregion

#region Statistics

private async Task ShowStatistics()
{
    if (jsonToken == null) return;

    // Enable Loading
    isLoading = true;
    loadingMessage = "Calculating JSON statistics...";
    StateHasChanged();

    try
    {
        await Task.Delay(100); // Ensure render

        // Calculate statistics
        currentStats = CalculateStatistics();

        // Show Modal
        showStatistics = true;

        await Task.Delay(50);
        StateHasChanged();
    }
    catch (Exception ex)
    {
        Console.WriteLine($"Error calculating statistics: {ex.Message}");
    }
    finally
    {
        // Disable Loading
        isLoading = false;
        StateHasChanged();
    }
}

private void CloseStatistics()
{
    showStatistics = false;
    StateHasChanged();
}

#endregion


}

<style>
    /* #region Container & Main Layout */

    .btn {
        min-width: 42px;
        min-height: 42px;
        padding: 8px;
        display: flex;
        align-items: center;
        justify-content: center;
    }

    .json-viewer-container {
        font-family: 'Consolas', 'Monaco', 'Courier New', monospace;
        font-size: 14px;
        line-height: 20px;
        position: relative;
        padding: 15px;
        border-radius: 8px;
        border: 1px solid #e0e0e0;
        background-color: #ffffff;
        display: flex;
        flex-direction: column;
    }

    /* ðŸ”º Ø¨Ø®Ø´ Ø¨Ø§Ù„Ø§ */
    .json-viewer-top-section {
        width: 100%;
    }

    .upper-buttoms {
        margin-bottom: 15px;
    }

    .upper-buttoms-full-screen {
        position: sticky;
        top: 0;
        z-index: 100;
        background: inherit;
        padding: 10px 0;
        margin-bottom: 15px;
    }

    /* Main Layout with three columns */
    .json-viewer-main-layout {
        display: flex;
        flex-direction: row;
        gap: 10px;
        flex: 1;
        position: relative;
    }

    /* â—€ï¸ Ø¨Ø®Ø´ Ú†Ù¾ */
    .json-viewer-left-section {
        flex-shrink: 0;
        width: 0; /* Empty for future use */
    }

    /* ðŸ“„ Ø¨Ø®Ø´ Ù…Ø­ØªÙˆØ§ÛŒ Ù…Ø±Ú©Ø²ÛŒ */
    .json-content-wrapper {
        flex: 1;
        position: relative;
        width: 100%;
    }

    /* ðŸ”» Ø¨Ø®Ø´ Ù¾Ø§ÛŒÛŒÙ† */
    .json-viewer-bottom-section {
        width: 100%;
        height: 0; /* Empty for future use */
    }
    /* #endregion */

    /* #region VS Code Style Viewer - SYNCED VERSION */
    .vscode-json-viewer {
        display: flex;
        background-color: #ffffff;
        border: 1px solid #e0e0e0;
        border-radius: 6px;
        overflow: hidden;
        max-height: 600px;
        font-family: 'Consolas', 'Monaco', 'Courier New', monospace;
        position: relative;
    }

    .vscode-line-numbers {
        flex-shrink: 0;
        padding: 10px 8px;
        background-color: #f5f5f5;
        border-right: 1px solid #e0e0e0;
        text-align: right;
        user-select: none;
        min-width: 50px;
        color: #858585;
        overflow: hidden;
        max-height: 600px;
    }

    .vscode-line-number {
        height: 20px;
        line-height: 20px;
        padding-right: 12px;
        font-size: 13px;
        font-family: 'Consolas', 'Monaco', 'Courier New', monospace;
        color: #858585;
        background-color: #f5f5f5;
        text-align: right;
        display: block;
        box-sizing: border-box;
        user-select: none;
        white-space: nowrap;
    }

    .vscode-json-content {
        flex: 1;
        padding: 10px 0;
        position: relative;
        overflow-y: auto;
        max-height: 600px;
    }

    .vscode-json-line {
        position: relative;
        min-height: 20px;
        line-height: 20px;
        white-space: pre;
    }

    .vscode-line-content {
        position: relative;
        display: inline-block;
    }
    /* #endregion */

    /* #region VS Code Style Scrollbar */
    .vscode-json-content::-webkit-scrollbar {
        width: 14px;
        height: 14px;
    }

    .vscode-json-content::-webkit-scrollbar-track {
        background: transparent;
    }

    .vscode-json-content::-webkit-scrollbar-thumb {
        background-color: rgba(121, 121, 121, 0.4);
        border-radius: 10px;
        border: 4px solid transparent;
        background-clip: padding-box;
    }

        .vscode-json-content::-webkit-scrollbar-thumb:hover {
            background-color: rgba(100, 100, 100, 0.7);
        }

        .vscode-json-content::-webkit-scrollbar-thumb:active {
            background-color: rgba(85, 85, 85, 0.8);
        }

    /* Dark Theme Scrollbar */
    .dark-theme .vscode-json-content::-webkit-scrollbar-thumb {
        background-color: rgba(121, 121, 121, 0.4);
    }

        .dark-theme .vscode-json-content::-webkit-scrollbar-thumb:hover {
            background-color: rgba(165, 165, 165, 0.7);
        }

        .dark-theme .vscode-json-content::-webkit-scrollbar-thumb:active {
            background-color: rgba(191, 191, 191, 0.8);
        }

    /* Line Numbers Scrollbar */
    .vscode-line-numbers::-webkit-scrollbar {
        width: 14px;
    }

    .vscode-line-numbers::-webkit-scrollbar-track {
        background: transparent;
    }

    .vscode-line-numbers::-webkit-scrollbar-thumb {
        background-color: rgba(121, 121, 121, 0.4);
        border-radius: 10px;
        border: 4px solid transparent;
        background-clip: padding-box;
    }

        .vscode-line-numbers::-webkit-scrollbar-thumb:hover {
            background-color: rgba(100, 100, 100, 0.7);
        }

    .dark-theme .vscode-line-numbers::-webkit-scrollbar-thumb {
        background-color: rgba(121, 121, 121, 0.4);
    }

        .dark-theme .vscode-line-numbers::-webkit-scrollbar-thumb:hover {
            background-color: rgba(165, 165, 165, 0.7);
        }
    /* #endregion */

    /* #region Indent Guides */
    .indent-guide {
        position: absolute;
        top: 0;
        bottom: 0;
        width: 1px;
        background-color: rgba(128, 128, 128, 0.15);
        pointer-events: none;
    }
    /* #endregion */

    /* #region JSON Syntax Highlighting */
    .json-property-name {
        color: #0451a5;
        font-weight: 500;
    }

    .json-string {
        color: #a31515;
    }

    .json-number {
        color: #098658;
    }

    .json-boolean {
        color: #0000ff;
    }

    .json-null {
        color: #808080;
    }

    .json-punctuation {
        color: #000000;
        margin-left:7px;
    }

    .json-collapsed {
        color: #999999;
        font-style: italic;
    }

    .json-toggle {
        cursor: pointer;
        user-select: none;
        color: #666;
        margin-right: -5px;
        margin-left: 2px;
        width: 16px;
        display: inline-block;
        text-align: center;
    }

        .json-toggle:hover {
            color: #007bff;
        }
    /* #endregion */

    /* #region Dark Theme */
    .dark-theme {
        background-color: #1e1e1e;
        color: #d4d4d4;
    }

        .dark-theme .json-viewer-container {
            background-color: #1e1e1e;
            border-color: #3c3c3c;
        }

        .dark-theme .vscode-json-viewer {
            background-color: #1e1e1e;
            border-color: #3c3c3c;
        }

        .dark-theme .vscode-line-numbers {
            background-color: #252526;
            border-right-color: #3c3c3c;
            color: #858585;
        }

        .dark-theme .vscode-line-number {
            background-color: #252526 !important;
            color: #858585 !important;
        }

        .dark-theme .json-property-name {
            color: #9cdcfe;
        }

        .dark-theme .json-string {
            color: #ce9178;
        }

        .dark-theme .json-number {
            color: #b5cea8;
        }

        .dark-theme .json-boolean {
            color: #569cd6;
        }

        .dark-theme .json-null {
            color: #808080;
        }

        .dark-theme .json-punctuation {
            color: #d4d4d4;
            margin-left:7px;
        }

        .dark-theme .indent-guide {
            background-color: rgba(255, 255, 255, 0.08);
        }

        .dark-theme .json-editor {
            background-color: #1e1e1e;
            color: #d4d4d4;
            border-color: #3c3c3c;
        }

        .dark-theme .loading-overlay {
            background: rgba(30, 30, 30, 0.9);
        }

        .dark-theme .alert-info {
            background-color: #1e3a5f;
            border-color: #2e5a8f;
            color: #d4d4d4;
        }
    /* #endregion */

    /* #region Loading Overlay */
    .loading-overlay {
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: rgba(255, 255, 255, 0.9);
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        z-index: 1000;
        border-radius: 8px;
    }

    .loading-spinner {
        border: 4px solid #f3f3f3;
        border-top: 4px solid #007bff;
        border-radius: 50%;
        width: 50px;
        height: 50px;
        animation: spin 1s linear infinite;
    }

    .loading-text {
        margin-top: 15px;
        color: #007bff;
        font-weight: 500;
    }

    @@keyframes spin {
        0% {
            transform: rotate(0deg);
        }

        100% {
            transform: rotate(360deg);
        }
    }
    /* #endregion */

    /* #region Edit Mode */
    .edit-mode-container {
        margin-top: 20px;
    }

    .json-editor {
        font-family: 'Consolas', 'Monaco', monospace;
        font-size: 14px;
        line-height: 1.5;
        background-color: #f8f9fa;
        border: 1px solid #ced4da;
        border-radius: 4px;
        padding: 10px;
        width: 100%;
        resize: vertical;
    }
    /* #endregion */

    /* #region Full Screen Mode */
    .full-screen {
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        z-index: 9999;
        background: white;
        padding: 20px;
        margin: 0;
        border-radius: 0;
    }

        .full-screen .vscode-json-viewer {
            max-height: calc(100vh - 100px);
        }

    .dark-theme.full-screen {
        background: #1e1e1e;
    }
    /* #endregion */

    /* #region Alert & Info Messages */
    .alert {
        padding: 15px;
        border-radius: 6px;
        margin: 10px 0;
    }

    .alert-info {
        background-color: #d1ecf1;
        border: 1px solid #bee5eb;
        color: #0c5460;
    }

        .alert-info i {
            margin-right: 8px;
        }
    /* #endregion */

    /* #region Button Styles */
    .btn {
        display: inline-flex;
        align-items: center;
        gap: 5px;
        padding: 6px 12px;
        border: 1px solid transparent;
        border-radius: 4px;
        font-size: 14px;
        cursor: pointer;
        transition: all 0.2s;
    }

    .btn-sm {
        padding: 4px 8px;
        font-size: 13px;
    }

    .btn-light {
        background-color: #f8f9fa;
        border-color: #dee2e6;
        color: #212529;
    }

        .btn-light:hover {
            background-color: #e9ecef;
            border-color: #adb5bd;
        }

    .btn-success {
        background-color: #28a745;
        border-color: #28a745;
        color: white;
    }

        .btn-success:hover {
            background-color: #218838;
            border-color: #1e7e34;
        }

    .btn-secondary {
        background-color: #6c757d;
        border-color: #6c757d;
        color: white;
    }

        .btn-secondary:hover {
            background-color: #5a6268;
            border-color: #545b62;
        }

    .dark-theme .btn-light {
        background-color: #2d2d30;
        border-color: #3c3c3c;
        color: #d4d4d4;
    }

        .dark-theme .btn-light:hover {
            background-color: #3c3c3c;
            border-color: #4d4d4d;
        }
    /* #endregion */

    /* #region Utility Classes */
    .d-flex {
        display: flex;
    }

    .justify-content-between {
        justify-content: space-between;
    }

    .align-items-center {
        align-items: center;
    }

    .gap-2 {
        gap: 8px;
    }

    .flex-wrap {
        flex-wrap: wrap;
    }

    .mb-0 {
        margin-bottom: 0;
    }

    .mb-2 {
        margin-bottom: 8px;
    }

    .mb-3 {
        margin-bottom: 16px;
    }
    /* #endregion */

    /* #region Scroll Navigation Buttons */
    .scroll-navigation-buttons {
        display: flex;
        flex-direction: column;
        gap: 8px;
    }

    .scroll-nav-btn {
        min-width: 40px;
        padding: 6px 10px;
    }

        .scroll-nav-btn .icon {
            display: inline-block;
        }

    /* Full Screen Mode */
    .full-screen .scroll-navigation-buttons {
        gap: 10px;
    }

    .full-screen .scroll-nav-btn {
        min-width: 45px;
        padding: 8px 12px;
    }
    /* #endregion */

    /* #region Left Sidebar Buttons */
    .json-viewer-with-sidebar {
        display: flex;
        gap: 12px;
    }

    .json-left-sidebar {
    display: flex;
    flex-direction: column;
    gap: 8px;
    width: 60px;
    flex-shrink: 0;
    padding: 10px 5px;
    }

        .json-left-sidebar .btn {
            min-width: 42px;
            min-height: 42px;
            padding: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

            .json-left-sidebar .btn i {
                font-size: 18px;
            }

    .json-main-content {
        flex: 1;
        min-width: 0;
    }
    /* #endregion */

    /* #region Selected Button Style */
    .selected-btn-light-them {
        background-color: #0d6efd !important;
        color: white !important;
        border-color: #0d6efd !important;
    }

    .dark-theme .selected-btn-light-them {
        background-color: #0a58ca !important;
        color: white !important;
    }
    /* #endregion */

    /* #region Left Sidebar */
    .json-left-sidebar {
        display: flex;
        flex-direction: column;
        gap: 8px;
        padding: 10px 5px;
        background-color: #f8f9fa;
        border-radius: 6px;
        border: 1px solid #e0e0e0;
        flex: 0 0 auto;
    }

    .dark-theme .json-left-sidebar {
        background-color: #2d2d30;
        border-color: #3c3c3c;
    }
    /* #endregion */

    /* #region Top Toolbar */
    .json-top-toolbar {
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 10px;
        padding: 5px;
        background-color: #f5f5f5;
        border: 1px solid #ddd;
        border-radius: 6px;
    }

    .json-top-toolbar .btn-light{
        min-height:50px;
    }

    .dark-theme .json-top-toolbar {
        background-color: #2d2d30;
        border-color: #3c3c3c;
    }
    /* #endregion */

    /* #region Content Column Wrapper */
    .json-content-column {
        flex: 1;
        display: flex;
        flex-direction: column;
        gap: 10px;
    }
    /* #endregion */

    /* #region right Sidebar Buttons */

    .json-viewer-right-section {
        display: flex;
        flex-direction: column;
        gap: 8px;
        flex-shrink: 0;
        align-items: flex-end;
        justify-content: flex-end;
    }

        .json-viewer-right-section .btn {
            min-width: 42px;
            min-height: 42px;
            padding: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

            .json-viewer-right-section .btn i {
                font-size: 18px;
            }

    /* #endregion */

    /* #region right Sidebar */
    .json-viewer-right-section {
        display: flex;
        flex-direction: column;
        gap: 8px;
        padding: 10px 5px;
        background-color: #f8f9fa;
        border-radius: 6px;
        border: 1px solid #e0e0e0;
        flex: 0 0 auto;
    }

    .dark-theme .json-viewer-right-section {
        background-color: #2d2d30;
        border-color: #3c3c3c;
    }
    /* #endregion */

    /* #region Toggle Animation */
    .vscode-json-line {
        transition: all 0.2s ease;
        opacity: 1;
    }

        .vscode-json-line.collapsing {
            opacity: 0;
            max-height: 0;
            overflow: hidden;
            transition: opacity 0.15s ease, max-height 0.15s ease;
        }

    .json-toggle {
        transition: transform 0.2s ease;
        display: inline-block;
    }

        .json-toggle.expanded {
            transform: rotate(0deg);
        }

        .json-toggle.collapsed {
            transform: rotate(-90deg);
        }
    /* #endregion */

    /* #region Hover Effect for JSON Lines */
    .vscode-json-line {
        position: relative;
        cursor: pointer;
        transition: background-color 0.15s ease;
    }

        .vscode-json-line:hover {
            background-color: rgba(0, 0, 0, 0.03);
        }

    .dark-theme .vscode-json-line:hover {
        background-color: rgba(255, 255, 255, 0.05);
    }

    /* Hover effect for Line Numbers */
    .vscode-line-number {
        transition: background-color 0.15s ease;
    }

    .vscode-json-line:hover + .vscode-line-number,
    .vscode-line-numbers:hover .vscode-line-number {
        background-color: rgba(0, 0, 0, 0.02);
    }

    .dark-theme .vscode-json-line:hover + .vscode-line-number,
    .dark-theme .vscode-line-numbers:hover .vscode-line-number {
        background-color: rgba(255, 255, 255, 0.03);
    }
    /* #endregion */

    /* #region Active Line Highlight */
    .vscode-json-line.active-line {
        background-color: rgba(0, 122, 204, 0.1) !important;
        border-left: 2px solid #007acc;
        padding-left: 8px;
    }

    .dark-theme .vscode-json-line.active-line {
        background-color: rgba(255, 255, 255, 0.08) !important;
        border-left: 2px solid #0098ff;
    }

    /* Active Line Number Highlight */
    .vscode-line-number.active-line-number {
        background-color: rgba(0, 122, 204, 0.15) !important;
        color: #007acc !important;
        font-weight: 600;
        border-radius: 2px;
    }

    .dark-theme .vscode-line-number.active-line-number {
        background-color: rgba(255, 255, 255, 0.1) !important;
        color: #0098ff !important;
    }
    /* #endregion */

    /* #region Smooth Scrollbar Appearance */
    .vscode-json-content::-webkit-scrollbar-thumb,
    .vscode-line-numbers::-webkit-scrollbar-thumb {
        transition: background-color 0.3s ease, opacity 0.3s ease;
        opacity: 0.4;
    }

    .vscode-json-content:hover::-webkit-scrollbar-thumb,
    .vscode-line-numbers:hover::-webkit-scrollbar-thumb {
        opacity: 1;
    }

    .vscode-json-content::-webkit-scrollbar-thumb:hover {
        opacity: 1 !important;
    }

    /* Scrollbar Track Ø¨Ø§ Fade */
    .vscode-json-content::-webkit-scrollbar,
    .vscode-line-numbers::-webkit-scrollbar {
        transition: opacity 0.2s ease;
    }

    /* Idle state (when mouse is not near) */
    .vscode-json-viewer:not(:hover) .vscode-json-content::-webkit-scrollbar-thumb,
    .vscode-json-viewer:not(:hover) .vscode-line-numbers::-webkit-scrollbar-thumb {
        opacity: 0.2;
    }

    /* Active state (during Scroll) */
    .vscode-json-content::-webkit-scrollbar-thumb:active,
    .vscode-line-numbers::-webkit-scrollbar-thumb:active {
        opacity: 1 !important;
        background-color: rgba(85, 85, 85, 0.8);
    }

    .dark-theme .vscode-json-content::-webkit-scrollbar-thumb:active,
    .dark-theme .vscode-line-numbers::-webkit-scrollbar-thumb:active {
        background-color: rgba(191, 191, 191, 0.8);
    }

    /* Smooth animation for appearance */
    .vscode-json-viewer {
        --scrollbar-transition-speed: 0.3s;
    }

    .vscode-json-content::-webkit-scrollbar,
    .vscode-line-numbers::-webkit-scrollbar {
        transition: opacity var(--scrollbar-transition-speed) ease;
    }
    /* #endregion */

    /* #region Search & Navigation */

    .json-top-toolbar {
        width: 100%;
    }

    .search-navigation-container {
        display: flex;
        align-items: center;
        gap: 10px;
        padding: 8px;
        background-color: #f8f9fa;
        border: 1px solid #dee2e6;
        border-radius: 6px;
    }

    .search-input-wrapper {
        position: relative;
        flex: 1;
        max-width: 400px;
    }

        .search-input-wrapper .btn {
            min-width: 36px;
            min-height: 36px;
    }

    .search-input {
        width: 100%;
        padding: 6px 32px 6px 12px;
        font-size: 14px;
        border: 1px solid #ced4da;
        border-radius: 4px;
        transition: border-color 0.2s;
    }

        .search-input:focus {
            border-color: #80bdff;
            outline: 0;
            box-shadow: 0 0 0 0.2rem rgba(0, 123, 255, 0.25);
        }

    .search-clear-btn {
        position: absolute;
        right: 4px;
        top: 50%;
        transform: translateY(-50%);
        padding: 4px 8px;
        border: none;
        background: transparent;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
    }

        .search-clear-btn:hover {
            background-color: #e9ecef;
            border-radius: 4px;
        }

    .search-navigation-buttons {
        display: flex;
        gap: 4px;
    }

        .search-navigation-buttons .btn {
            min-width: 36px;
            min-height: 36px;
            padding: 6px;
        }

    .search-match-counter {
        padding: 6px 12px;
        background-color: #fff;
        border: 1px solid #dee2e6;
        border-radius: 4px;
        font-size: 13px;
        min-width: 100px;
        text-align: center;
        margin-right:10px;
    }

    .match-info {
        color: #28a745;
        font-weight: 600;
    }

    .no-match-info {
        color: #dc3545;
        font-weight: 500;
    }

    .search-navigation-container {
        min-width:500px;
    }

    /* Dark Theme Support */
    .dark-theme .search-navigation-container {
        background-color: #2d2d30;
        border-color: #3e3e42;
    }

    .dark-theme .search-input {
        background-color: #3c3c3c;
        color: #d4d4d4;
        border-color: #3e3e42;
    }

    .dark-theme .search-match-counter {
        background-color: #3c3c3c;
        border-color: #3e3e42;
        color: #d4d4d4;
    }

    .dark-theme .search-clear-btn:hover {
        background-color: #505050;
    }
    /* #endregion */

    /* #region Search Highlighting */
    .search-highlight {
        background-color: #ffeb3b;
        color: #000;
        padding: 2px 4px;
        border-radius: 2px;
    }

    .search-highlight-current {
        background-color: #ff9800;
        color: #fff;
        padding: 2px 4px;
        border-radius: 2px;
        font-weight: 600;
    }

    @@keyframes searchPulse {
        0%, 100%

    {
        background-color: transparent;
    }

    50% {
        background-color: rgba(255, 152, 0, 0.3);
    }

    }

    .search-highlight-pulse {
        animation: searchPulse 1s ease-in-out;
    }

    /* For JSON Line */
    .vscode-json-line.search-highlight-pulse {
        background-color: rgba(255, 152, 0, 0.2);
    }

    /* Dark Theme Support */
    .dark-theme .search-highlight {
        background-color: #ffd54f;
        color: #000;
    }

    .dark-theme .search-highlight-current {
        background-color: #ff6f00;
        color: #fff;
    }

    .dark-theme .search-highlight-pulse {
        animation: searchPulseDark 1s ease-in-out;
    }

    @@keyframes searchPulseDark {
        0%, 100%

    {
        background-color: transparent;
    }

    50% {
        background-color: rgba(255, 152, 0, 0.4);
    }

    }

    /* #endregion */

    /* #region Search Line Styling */
    .has-search-match {
        background-color: rgba(255, 235, 59, 0.1);
        transition: background-color 0.3s ease;
    }

    .dark-theme .has-search-match {
        background-color: rgba(255, 213, 79, 0.15);
    }

    .has-search-match:hover {
        background-color: rgba(255, 235, 59, 0.2);
    }

    .dark-theme .has-search-match:hover {
        background-color: rgba(255, 213, 79, 0.25);
    }
    /* #endregion */

/* #region FullScreen Styles */

/* FullScreen state for main Container */
.json-viewer-container.fullscreen-active {
    position: fixed !important;
    top: 0 !important;
    left: 0 !important;
    width: 100vw !important;
    height: 100vh !important;
    z-index: 9999 !important;
    margin: 0 !important;
    padding: 0 !important;
    overflow: hidden !important;
    border-radius: 0 !important;
}

/* Main Layout in FullScreen */
.fullscreen-active .json-viewer-main-layout {
    height: 100vh !important;
    display: flex !important;
    flex-direction: column !important;
    padding: 15px !important;
    gap: 0 !important;
}

/* Content Wrapper in FullScreen */
.fullscreen-active .json-content-wrapper {
    flex: 1 !important;
    display: flex !important;
    flex-direction: column !important;
    overflow: hidden !important;
    height: 100% !important;
}

/* JSON Viewer with Sidebar in FullScreen */
.fullscreen-active .json-viewer-with-sidebar {
    flex: 1 !important;
    display: flex !important;
    gap: 10px !important;
    height: 100% !important;
    overflow: hidden !important;
}

/* Left Sidebar in FullScreen */
.fullscreen-active .json-left-sidebar {
    flex-shrink: 0 !important;
    display: flex !important;
    flex-direction: column !important;
    gap: 8px !important;
    padding: 10px 5px !important;
    height: 100% !important;
    overflow-y: auto !important;
}

/* Content Column in FullScreen */
.fullscreen-active .json-content-column {
    flex: 1 !important;
    display: flex !important;
    flex-direction: column !important;
    gap: 10px !important;
    overflow: hidden !important;
    height: 100% !important;
}

/* Top Toolbar in FullScreen */
.fullscreen-active .json-top-toolbar {
    flex-shrink: 0 !important;
    padding: 8px 12px !important;
    border-radius: 6px !important;
}

/* Main Content in FullScreen */
.fullscreen-active .json-main-content {
    flex: 1 !important;
    overflow: hidden !important;
    display: flex !important;
    flex-direction: column !important;
    height: 100% !important;
}

/* VS Code Viewer in FullScreen */
.fullscreen-active .vscode-json-viewer {
    flex: 1 !important;
    height: 100% !important;
    max-height: none !important;
    display: flex !important;
    overflow: hidden !important;
}

/* Line Numbers in FullScreen - no scrollbar */
.fullscreen-active .vscode-line-numbers {
    height: 100% !important;
    max-height: none !important;
    overflow: hidden !important;
}

/* JSON Content in FullScreen - only scroll here */
.fullscreen-active .vscode-json-content {
    height: 100% !important;
    max-height: none !important;
    overflow-y: auto !important;
    overflow-x: auto !important;
    flex: 1 !important;
}

/* Right Section in FullScreen */
.fullscreen-active .json-viewer-right-section {
    flex-shrink: 0 !important;
    display: flex !important;
    flex-direction: column !important;
    gap: 8px !important;
    padding: 10px 5px !important;
    height: 100% !important;
}

/* Scroll Navigation Buttons in FullScreen */
.fullscreen-active .scroll-navigation-buttons {
    display: flex !important;
    flex-direction: column !important;
    gap: 8px !important;
}

/* Search Container in FullScreen */
.fullscreen-active .search-navigation-container {
    flex: 1 !important;
    max-width: 500px !important;
}

/* FullScreen enter animation */
.json-viewer-container {
    transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
}

.fullscreen-active {
    animation: fullscreenEnter 0.3s ease-out;
}

@@keyframes fullscreenEnter {
    from {
        opacity: 0.8;
        transform: scale(0.98);
    }
    to {
        opacity: 1;
        transform: scale(1);
    }
}

/* Lock Scroll on Body */
body.fullscreen-mode {
    overflow: hidden !important;
    position: fixed !important;
    width: 100% !important;
    height: 100% !important;
}

html.fullscreen-active {
    overflow: hidden !important;
}

/* #endregion */

</style>

